<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://hl7.org/fhir/STU3/testscript.sch" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?>
<TestScript xmlns="http://hl7.org/fhir"
            xmlns:nts="http://nictiz.nl/xsl/testscript"
            nts:scenario="client">
   <id value="gbz-fhir3-0-2-ikz-phr-4-3"/>
   <version value="stu3-3.0"/>
   <name value="Nictiz Geboortezorg - Client - Scenario 4.3 - Retrieve Integrale Zwangerschapskaart resources of Micha Yassien-Mohamed  (perinatal and maternal death)"/>
   <description value="Scenario 4.3: Retrieve Integrale Zwangerschapskaart resources of Micha Yassien-Mohamed (perinatal and maternal death)"/>
   <nts:authToken patientResourceId="MICHA-M-XXX-YASSIEN-MOHAMED"/>
   <nts:include value="gbz-variable-episode-id" name="episode-id" sourceId="fixture-5-ServeMaternalRecord"/>
   <variable><name value="T"/><defaultValue value="${CURRENTDATE}"/></variable>
   <!-- Patient - Zwangere vrouw -->
   <test id="1-RetrieveWoman">
      <name value="1-RetrieveWoman"/>
      <description value="Query Patient resource for HCIM Woman"/>
      <nts:include value="medmij/test.phr.successfulsearch" scope="common">
         <nts:with-parameter name="resource" value="Patient"/>
      </nts:include>
      <nts:include value="assert.response.numResources" scope="common">
         <nts:with-parameter name="resource" value="Patient"/>
         <nts:with-parameter name="count" value="1"/>
         <nts:with-parameter name="atLeast"/>
      </nts:include>
   </test>

   <!-- EpisodeOfCare - zorgepisode zwangerschap -->
   <test id="5-RetrieveMaternalRecord">
      <name value="5-RetrieveMaternalRecord"/>
      <description value="Test Server query operation for MaternalRecord (EpisodeOfCare) including managing organization (Organization) and care manager (Practitioner)"/>
      <nts:include value="medmij/test.phr.successfulsearch" scope="common">
         <nts:with-parameter name="resource" value="EpisodeOfCare"/>
         <nts:with-parameter name="params" value="?type=http://snomed.info/sct|364320009&amp;_include=EpisodeOfCare:organization&amp;_include=EpisodeOfCare:care-manager"/>
         <nts:with-parameter name="responseId" value="fixture-5-ServeMaternalRecord"/>
      </nts:include>
      <nts:include value="assert.response.numResources" scope="common" resource="EpisodeOfCare" count="1"/>
      <nts:include value="assert.response.numResources" scope="common" resource="Organization" count="1"/>
      <nts:include value="assert.response.numResources" scope="common" resource="Practitioner" count="1"/>
   </test>

   <!-- Conditions - Problemen gerelateerd aan zorgepisode -->
   <test id="6a-RetrieveConditions">
      <name value="6a-RetrieveConditions"/>
      <description value="Test Server query operation for Conditions (including Pregnancy)"/>
      <nts:include value="medmij/test.phr.successfulsearch" scope="common">
         <nts:with-parameter name="resource" value="Condition"/>
         <nts:with-parameter name="params" value="?context=EpisodeOfCare/${episode-id}"/>
      </nts:include>
      <!-- bevinding betreffende zwangerschap (bevinding) -->
      <nts:include value="gbz-assert-returnCountWithCode">
         <nts:with-parameter name="additionalDescription" value="bevinding betreffende zwangerschap (bevinding)"/>
         <nts:with-parameter name="resource" value="Condition"/>
         <nts:with-parameter name="count" value="1"/>
         <nts:with-parameter name="code" value="118185001"/>
         <nts:with-parameter name="system" value="http://snomed.info/sct"/>
      </nts:include>
   </test>

   <!-- Encounters -->
   <test id="7-RetrieveEncounters">
      <name value="7-RetrieveEncounters"/>
      <description value="Test Server query operation for Encounters"/>
      <nts:include value="medmij/test.phr.successfulsearch" scope="common">
         <nts:with-parameter name="resource" value="Encounter"/>
         <nts:with-parameter name="params" value="?episodeofcare=EpisodeOfCare/${episode-id}&amp;_include=Encounter:practitioner"/>
      </nts:include>
      <nts:include value="assert.response.numResources" scope="common" resource="Encounter" count="2"/>
      <nts:include value="assert.response.numResources" scope="common" resource="Practitioner" count="1"/>
      <!-- consult (verrichting) -->
      <nts:include value="assert.response.numResourcesWithCode" scope="common">
         <nts:with-parameter name="additionalDescription" value="(ContactSoort)"/>
         <nts:with-parameter name="codedElement" value="type"/>
         <nts:with-parameter name="resource" value="Encounter"/>
         <nts:with-parameter name="count" value="2"/>
         <nts:with-parameter name="code" value="11429006"/>
      </nts:include>
   </test>

   <!-- Observations - Observaties gekoppeld aan episode -->
   <test id="8a-RetrieveObservations">
      <name value="8a-RetrieveObservations"/>
      <description value="Test Server query operation for Observations"/>
      <nts:include value="medmij/test.phr.successfulsearch" scope="common">
         <nts:with-parameter name="resource" value="Observation"/>
         <nts:with-parameter name="params" value="?context=EpisodeOfCare/${episode-id}"/>
      </nts:include>
      <!-- [#] Parity -->
      <nts:include value="gbz-assert-returnCountWithCode">
         <nts:with-parameter name="additionalDescription" value="[#] Parity"/>
         <nts:with-parameter name="resource" value="Observation"/>
         <nts:with-parameter name="count" value="1"/>
         <nts:with-parameter name="code" value="11977-6"/>
         <nts:with-parameter name="system" value="http://loinc.org"/>
      </nts:include>
      <!-- [#] Pregnancies -->
      <nts:include value="gbz-assert-returnCountWithCode">
         <nts:with-parameter name="additionalDescription" value="[#] Pregnancies"/>
         <nts:with-parameter name="resource" value="Observation"/>
         <nts:with-parameter name="count" value="1"/>
         <nts:with-parameter name="code" value="11996-6"/>
         <nts:with-parameter name="system" value="http://loinc.org"/>
      </nts:include>
      <!-- Datum van laatste menstruatie [datum] -->
      <nts:include value="gbz-assert-returnCountWithCode">
         <nts:with-parameter name="additionalDescription" value="Datum van laatste menstruatie [datum]"/>
         <nts:with-parameter name="resource" value="Observation"/>
         <nts:with-parameter name="count" value="1"/>
         <nts:with-parameter name="code" value="8665-2"/>
         <nts:with-parameter name="system" value="http://loinc.org"/>
      </nts:include>
      <!-- geschatte datum van partus (waarneembare entiteit) -->
      <nts:include value="gbz-assert-returnCountWithCode">
         <nts:with-parameter name="additionalDescription" value="geschatte datum van partus (waarneembare entiteit)"/>
         <nts:with-parameter name="resource" value="Observation"/>
         <nts:with-parameter name="count" value="1"/>
         <nts:with-parameter name="code" value="161714006"/>
         <nts:with-parameter name="system" value="http://snomed.info/sct"/>
      </nts:include>
      <!-- zwangerschapsduur -->
      <nts:include value="gbz-assert-returnCountWithCode">
         <nts:with-parameter name="additionalDescription" value="zwangerschapsduur"/>
         <nts:with-parameter name="resource" value="Observation"/>
         <nts:with-parameter name="count" value="1"/>
         <nts:with-parameter name="code" value="57036006"/>
         <nts:with-parameter name="system" value="http://snomed.info/sct"/>
      </nts:include>
   </test>

   <!-- Observations - Observaties gekoppeld aan prenatale controle -->
   <test id="8b-RetrieveObservations">
      <name value="8b-RetrieveObservations"/>
      <description value="Test Server query operation for Observations"/>
      <nts:include value="medmij/test.phr.successfulsearch" scope="common">
         <nts:with-parameter name="resource" value="Observation"/>
         <nts:with-parameter name="params" value="?context:Encounter.episodeofcare=EpisodeOfCare/${episode-id}"/>
      </nts:include>
      <!-- Bloeddruk panel waarvan alle leden optioneel in arterieel vaatstelsel -->
      <nts:include value="gbz-assert-returnCountWithCode">
         <nts:with-parameter name="additionalDescription" value="Bloeddruk panel waarvan alle leden optioneel in arterieel vaatstelsel"/>
         <nts:with-parameter name="resource" value="Observation"/>
         <nts:with-parameter name="count" value="1"/>
         <nts:with-parameter name="code" value="85354-9"/>
         <nts:with-parameter name="system" value="http://loinc.org"/>
      </nts:include>
      <!-- aantal levende foetussen (waarneembare entiteit) -->
      <nts:include value="gbz-assert-returnCountWithCode">
         <nts:with-parameter name="additionalDescription" value="aantal levende foetussen (waarneembare entiteit)"/>
         <nts:with-parameter name="resource" value="Observation"/>
         <nts:with-parameter name="count" value="1"/>
         <nts:with-parameter name="code" value="142931000146106"/>
         <nts:with-parameter name="system" value="http://snomed.info/sct"/>
      </nts:include>
   </test>

   <!-- RelatedPerson -->
   <test id="13-RetrieveRelatedPerson">
      <name value="13-RetrieveRelatedPerson"/>
      <description value="Test Server query operation for RelatedPerson"/>
      <nts:include value="medmij/test.phr.successfulsearch" scope="common">
         <nts:with-parameter name="resource" value="RelatedPerson"/>
      </nts:include>
      <nts:include value="assert.response.numResources" scope="common">
         <nts:with-parameter name="resource" value="RelatedPerson"/>
         <nts:with-parameter name="count" value="1"/>
      </nts:include>
   </test>

</TestScript>
