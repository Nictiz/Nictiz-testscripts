<?xml version="1.0" encoding="UTF-8"?>
<TestScript xmlns="http://hl7.org/fhir"
            xmlns:nts="http://nictiz.nl/xsl/testscript"
            nts:scenario="sturen">
    
    <!-- General info -->
    <id value="TEST-lr-Scenario1a-Send"/>
    <version value="R4-3.0"/>
    <name value="LaboratoryResults - Scenario 1a - Send lab results"/>
    <description value="Scenario 1a - Send a NHG-coded panel of laboratory results to the receiving system."/>
    
    <!-- Point to your FHIR bundle -->
    <nts:fixture
        id="lr-fixture-1"
        href="resources-to-sendreceive/lr-slr-TEST-l2z-1Maximaal-bericht-1MMBLOINC.xml"/>
    
    <nts:includeDateT value="yes"/>
    
    <!-- The actual test -->
    <test id="lr-send-basic">
        <name value="Send LaboratoryResults Bundle"/>
        <description value="POST the LaboratoryResults FHIR Bundle to the receiver endpoint"/>
        
        <!-- Step 1: Send the bundle -->
        <action>
            <operation>
                <type>
                    <coding>
                        <system value="http://hl7.org/fhir/testscript-operation-codes"/>
                        <code value="create"/>
                    </coding>
                </type>
                <resource value="Bundle"/>
                <description value="Send LaboratoryResults FHIR Bundle"/>
                <accept value="application/fhir+xml"/>
                <contentType value="application/fhir+xml"/>
                <sourceId value="lr-fixture-1"/>
                <url value="Bundle"/>
            </operation>
        </action>
        
        <!-- Step 2: Check that response is OK -->
        <action>
            <assert>
                <description value="Response should be HTTP 201 Created or 200 OK"/>
                <direction value="response"/>
                <responseCode value="201"/>
            </assert>
        </action>
        
        <!-- Optional Step 3: Check that the Observation is included -->
        <action>
            <assert>
                <description value="At least one Observation should be present in the bundle"/>
                <direction value="response"/>
                <expression value="Bundle.entry.resource.ofType(Observation).exists()"/>
            </assert>
        </action>
        
        <!-- Optional Step 4: Check that the Patient exists -->
        <action>
            <assert>
                <description value="Patient resource should be present in the bundle"/>
                <direction value="response"/>
                <expression value="Bundle.entry.resource.ofType(Patient).exists()"/>
            </assert>
        </action>
        
    </test>
</TestScript>