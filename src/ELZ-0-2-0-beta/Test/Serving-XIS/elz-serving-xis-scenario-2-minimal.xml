<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://hl7.org/fhir/STU3/testscript.sch" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?>
<TestScript xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript"
    nts:scenario="server">
    <id value="elz-serving-xis-scenario-2-minimal"/>
    <version value="R4"/>
    <name value="ELZ - Serving XIS - Scenario 2 - Serving ELZ resources of XXX-Andrioli"/>
    <description value="Scenario 2 - Serving ELZ resources of XXX-Andrioli"/>
    <nts:authToken patientResourceId="patient-XXX-Andrioli"/>
    
    <variable nts:in-targets="CheckContent">
        <name value="composition-hg-VerwijzingHuisartsParamedicusMinimaalbericht-id"/>
        <description value="Resource.id for Composition 1"/>
        <expression value="Composition.id"/>
        <sourceId value="fixture-03-serve-Composition"/>
    </variable>
     
    <variable>
        <name value="taskid-minimum"/>
        <description value="The resource id of the Task"/>
    </variable>
    
    <variable>
        <name value="servicerequestid"/>
        <description value="The resource id of the Servicerequest"/>
        <expression value="Task.focus.reference.replaceMatches('^.*ServiceRequest/','')"/>
        <sourceId value="taskfromserver"/>
    </variable>
   
    <variable>
        <name value="compositionid"/>
        <description value="The resource id of the Composition"/>
        <expression value="ServiceRequest.supportingInfo.first().reference.replaceMatches('^.*Composition/','')"/>
        <sourceId value="servicerequestfromserver"/>
    </variable>  

    <test id="01-serve-Task">
        <name value="Scenario 2.1 - Task"/>
        <description
            value="Serve Task resource"/>
        <nts:include value="test.server.successfulRead" scope="common"
            resource="Task"
            params="/${taskid}"
            useToken="true"
            responseId="taskfromserver"/>
        
        <nts:contentAsserts href="resources/task-hg-VerwijzingHuisartsParamedicusMinimaalbericht.xml"
            description="contains .code.coding.code = '3457005'" discriminator="code.where(coding.where(code = '3457005'))" nts:in-targets="CheckContent"/>            
        
    </test>

    <test id="02-serve-ServiceRequest">
        <name value="Scenario 2.2 - ServiceRequest"/>
        <description value="Serve ServiceRequest resource"/>
        <nts:include value="test.server.successfulRead" scope="common" 
            resource="ServiceRequest"
            params="/${servicerequestid}"
            useToken="true"
            responseId="servicerequestfromserver"/>
        
        <nts:contentAsserts href="resources/servicerequest-hg-VerwijzingHuisartsParamedicusMinimaalbericht.xml"
            description="contains .category.coding.code = '1'" discriminator="category.where(coding.where(code = '1'))" nts:in-targets="CheckContent"/>
        
    </test>

    <test id="03-serve-Composition">
        <name value="Scenario 2.3 - Composition"/>
        <description value="Serve Composition resource with all the references by using the Document operation"/>
        <nts:include value="test.server.successfulRead" scope="common" 
            resource="Composition"
            params="/${compositionid}"
            useToken="true"/>   
    </test>


    <test nts:in-targets="CheckContent">
        <name value="Scenario 2.3 - Composition - Check Composition"/>
        <description value="Check if the previous operation results in a FHIR Composition that contains the values that are expected following Nictiz' materials (fixture .id: composition-hg-VerwijzingHuisartsParamedicusMinimaalbericht)"/>
        <action>
            <assert>
                <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
                    <valueBoolean value="true"/>
                </extension>
                <description value="Response contains exactly 1 Composition"/>
                <direction value="response"/>
                <expression value="Composition.count() = 1"/>
                <warningOnly value="false"/>
            </assert>
        </action>
        <action>
            <assert>
                <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
                    <valueBoolean value="true"/>
                </extension>
                <description value="Composition resource evaluated in the previous assert contains an .id"/>
                <direction value="response"/>
                <expression value="Composition.id.exists()"/>
                <warningOnly value="false"/>
            </assert>
        </action>
        <action>
            <assert>
                <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
                    <valueBoolean value="false"/>
                </extension>
                <label value="1-1"/>
                <description value="Contains .meta with .profile 'http://nictiz.nl/fhir/StructureDefinition/hg-ReferralComposition'"/>
                <direction value="response"/>
                <expression value="Composition.where(id = '${composition-hg-VerwijzingHuisartsParamedicusMinimaalbericht-id}').meta.profile.where($this = 'http://nictiz.nl/fhir/StructureDefinition/hg-ReferralComposition').exists()"/>
                <warningOnly value="false"/>
            </assert>
        </action>
        <action>
            <assert>
                <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
                    <valueBoolean value="false"/>
                </extension>
                <label value="1-2"/>
                <description value="Contains .identifier with .system and .value"/>
                <direction value="response"/>
                <expression value="Composition.where(id = '${composition-hg-VerwijzingHuisartsParamedicusMinimaalbericht-id}').identifier.where(system and value).exists()"/>
                <warningOnly value="false"/>
            </assert>
        </action>
        <action>
            <assert>
                <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
                    <valueBoolean value="false"/>
                </extension>
                <label value="1-3"/>
                <description value="Contains .status 'final'"/>
                <direction value="response"/>
                <expression value="Composition.where(id = '${composition-hg-VerwijzingHuisartsParamedicusMinimaalbericht-id}').status = 'final'"/>
                <warningOnly value="false"/>
            </assert>
        </action>
        <action>
            <assert>
                <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
                    <valueBoolean value="false"/>
                </extension>
                <label value="1-4"/>
                <description value="Contains .type with .coding with .system 'http://loinc.org' and .code '57133-1' and .display"/>
                <direction value="response"/>
                <expression value="Composition.where(id = '${composition-hg-VerwijzingHuisartsParamedicusMinimaalbericht-id}').type.coding.where(system = 'http://loinc.org' and code = '57133-1' and display).exists()"/>
                <warningOnly value="false"/>
            </assert>
        </action>
        <action>
            <assert>
                <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
                    <valueBoolean value="false"/>
                </extension>
                <label value="1-5"/>
                <description value="Contains .subject with either .reference or .identifier and .display"/>
                <direction value="response"/>
                <expression value="Composition.where(id = '${composition-hg-VerwijzingHuisartsParamedicusMinimaalbericht-id}').subject.where((reference or identifier) and display).exists()"/>
                <warningOnly value="false"/>
            </assert>
        </action>
        <action>
            <assert>
                <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
                    <valueBoolean value="false"/>
                </extension>
                <label value="1-6"/>
                <description value="Contains .date"/>
                <direction value="response"/>
                <expression value="Composition.where(id = '${composition-hg-VerwijzingHuisartsParamedicusMinimaalbericht-id}').date.exists()"/>
                <warningOnly value="false"/>
            </assert>
        </action>
        <action>
            <assert>
                <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
                    <valueBoolean value="false"/>
                </extension>
                <label value="1-7"/>
                <description value="Contains .author with either .reference or .identifier and .display"/>
                <direction value="response"/>
                <expression value="Composition.where(id = '${composition-hg-VerwijzingHuisartsParamedicusMinimaalbericht-id}').author.where((reference or identifier) and display).exists()"/>
                <warningOnly value="false"/>
            </assert>
        </action>
        <action>
            <assert>
                <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
                    <valueBoolean value="false"/>
                </extension>
                <label value="1-8"/>
                <description value="Contains .title with a value. This assert only checks existence of a value, because string comparisons can have many possible caveats"/>
                <direction value="response"/>
                <expression value="Composition.where(id = '${composition-hg-VerwijzingHuisartsParamedicusMinimaalbericht-id}').title.hasValue()"/>
                <warningOnly value="true"/>
            </assert>
        </action>
        <action>
            <assert>
                <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
                    <valueBoolean value="false"/>
                </extension>
                <label value="1-9"/>
                <description value="Contains .section with .title with a value, and .code with .coding with .system 'http://snomed.info/sct' and .code '406550009' and .display. This assert checks if all children exist (if applicable with their specific values) and if they are present within one element. Following asserts check if individual children exist to help you debug if this assert fails"/>
                <direction value="response"/>
                <expression value="Composition.where(id = '${composition-hg-VerwijzingHuisartsParamedicusMinimaalbericht-id}').section.where(title.hasValue() and code.coding.where(system = 'http://snomed.info/sct' and code = '406550009' and display).exists()).exists()"/>
                <warningOnly value="false"/>
            </assert>
        </action>
        <action>
            <assert>
                <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
                    <valueBoolean value="false"/>
                </extension>
                <label value="1-9-1"/>
                <description value="Contains .section.title with a value. This assert checks only one child. Assert 1-9 checks if all children are present in the same parent. This assert only checks existence of a value, because string comparisons can have many possible caveats"/>
                <direction value="response"/>
                <expression value="Composition.where(id = '${composition-hg-VerwijzingHuisartsParamedicusMinimaalbericht-id}').section.where(title.hasValue()).exists()"/>
                <warningOnly value="true"/>
            </assert>
        </action>
        <action>
            <assert>
                <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
                    <valueBoolean value="false"/>
                </extension>
                <label value="1-9-2"/>
                <description value="Contains .section.code with .coding with .system 'http://snomed.info/sct' and .code '406550009' and .display. This assert checks only one child. Assert 1-9 checks if all children are present in the same parent"/>
                <direction value="response"/>
                <expression value="Composition.where(id = '${composition-hg-VerwijzingHuisartsParamedicusMinimaalbericht-id}').section.where(code.coding.where(system = 'http://snomed.info/sct' and code = '406550009' and display).exists()).exists()"/>
                <warningOnly value="false"/>
            </assert>
        </action>
        <action>
            <assert>
                <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
                    <valueBoolean value="false"/>
                </extension>
                <label value="1-9-3-1"/>
                <description value="Contains .section.section.extension with url 'http://nictiz.nl/fhir/StructureDefinition/ext-TextValue' with .valueString with a value. This assert checks only one child. Assert 1-9-3 checks if all children are present in the same parent"/>
                <direction value="response"/>
                <expression value="Composition.where(id = '${composition-hg-VerwijzingHuisartsParamedicusMinimaalbericht-id}').section.where(section.where(extension('http://nictiz.nl/fhir/StructureDefinition/ext-TextValue').value.ofType(string).hasValue())).exists()"/>
                <warningOnly value="false"/>
            </assert>
        </action>
        <action>
            <assert>
                <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
                    <valueBoolean value="false"/>
                </extension>
                <label value="1-9-4-1"/>
                <description value="Contains .section.section.extension with url 'http://nictiz.nl/fhir/StructureDefinition/ext-TextValue' with .valueString with a value. This assert checks only one child. Assert 1-9-4 checks if all children are present in the same parent"/>
                <direction value="response"/>
                <expression value="Composition.where(id = '${composition-hg-VerwijzingHuisartsParamedicusMinimaalbericht-id}').section.where(section.where(extension('http://nictiz.nl/fhir/StructureDefinition/ext-TextValue').value.ofType(string).hasValue())).exists()"/>
                <warningOnly value="false"/>
            </assert>
        </action>
    </test>

</TestScript>
