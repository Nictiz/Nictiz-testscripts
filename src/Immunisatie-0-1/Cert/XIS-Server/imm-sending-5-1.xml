<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://hl7.org/fhir/STU3/testscript.sch" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?>
<TestScript xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript"
    nts:scenario="server">
    <id value="imm-sending-2-1"/>
    <version value="r4-1.0.0"/>
    <name value="Immunization - XIS Server - Scenario 2.1 - Serve Immunization resources of 'van der Voorden-der Teeuwen'"/>
    <description value="Scenario 2.1 - Serve Immunization resources of 'van der Voorden-der Teeuwen'"/>
    <nts:patientTokenFixture href="imm-patient-van-der-Voorden-der-Teeuwen-token.xml"/>

    <variable>
        <name value="immunization-identifier-01"/>
        <expression
            value="Bundle.entry.where(resource.is(Immunization)).resource.identifier[0].value"/>
        <sourceId value="immunization-search-response"/>
    </variable>
    
    <variable>
        <name value="immunization-identifier-system-01"/>
        <expression
            value="Bundle.entry.where(resource.is(Immunization)).resource.identifier[0].system"/>
        <sourceId value="immunization-search-response"/>
    </variable>
    
    <variable>
        <name value="pharmaceuticalProduct-url-1"/>
        <!-- Pick the absolute url as is or create an absolute url when a relative url is given by combining the base url given in the Bundle self link with the relative reference.-->
        <expression
            value="iif(Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference.startsWith('Medication/'),
            Bundle.link.where(relation='self').url.replaceMatches('Immunization[/?].*$','') + Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference,
            Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference)"/>
        <sourceId value="immunization-search-response"/>
    </variable>

    <variable>
        <name value="pharmaceuticalProduct-url-2"/>
        <!-- Pick the absolute url as is or create an absolute url when a relative url is given by combining the base url given in the Bundle self link with the relative reference.-->
        <expression
            value="iif(Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference.startsWith('Medication/'),
            Bundle.link.where(relation='self').url.replaceMatches('Immunization[/?].*$','') + Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference,
            Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference)"/>
        <sourceId value="immunization-search-response"/>
    </variable>

    <variable>
        <name value="pharmaceuticalProduct-url-3"/>
        <!-- Pick the absolute url as is or create an absolute url when a relative url is given by combining the base url given in the Bundle self link with the relative reference.-->
        <expression
            value="iif(Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference.startsWith('Medication/'),
            Bundle.link.where(relation='self').url.replaceMatches('Immunization[/?].*$','') + Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference,
            Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference)"/>
        <sourceId value="immunization-search-response"/>
    </variable>

    <variable>
        <name value="pharmaceuticalProduct-url-4"/>
        <!-- Pick the absolute url as is or create an absolute url when a relative url is given by combining the base url given in the Bundle self link with the relative reference.-->
        <expression
            value="iif(Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference.startsWith('Medication/'),
            Bundle.link.where(relation='self').url.replaceMatches('Immunization[/?].*$','') + Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference,
            Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference)"/>
        <sourceId value="immunization-search-response"/>
    </variable>

    <test>
        <name value="Scenario 2.1 - Get Immunizations"/>
        <description
            value="Serve Immunization resource including the patient"/>
        <nts:include value="medmij/test.xis.successfulSearch" scope="common"
            resource="Immunization"
            params="?_include=Immunization:patient&#38;_include:iterate=Immunization:performer"
            responseId="immunization-search-response"/>
        <nts:include value="assert.response.numResources" scope="common"
            resource="Immunization" count="4"/>
        <nts:include value="assert.response.numResources" scope="common"
            resource="Patient" count="1"/>

            <!-- Test Immunization resource 1 -->
        <nts:include value="assert.identifier" direction="response" resource="Immunization"/>
        <nts:include value="assert.uniqueidentifier" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}" direction="response"/>
        <nts:include value="assert.medicationreference" direction="response" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.status" direction="response" status="completed" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.vaccincode" direction="response" resource="Immunization" vaccinCode="74691" vaccinCodeSystem="urn:oid:2.16.840.1.113883.2.4.4.10" vaccinCodeDisplay="Infanrix hexa Injsusp Wwsp 0,5ml" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.patientreference" direction="response" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.occurence" direction="response" occurence="2007-04-12T00:00:00+02:00" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <!-- site -->
        <nts:include value="assert.site" direction="response" lateralitycode="7771000" code="40983000" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <!-- route -->
        <nts:include value="assert.route" direction="response" code="2" system="urn:oid:2.16.840.1.113883.2.4.4.9" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <!-- dose -->
        <nts:include value="assert.dosequantity" direction="response" dosevalue="0.5" unit="ml" system="http://unitsofmeasure.org" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <!-- performer -->
        <nts:include value="assert.performer" direction="response" resource="Immunization" referenceType="PractitionerRole" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <!-- note -->
        <nts:include value="assert.note" direction="response" resource="Immunization" note="rechterbovenarm in gips" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <!-- reasonCode -->
        <nts:include value="assert.reasoncode" direction="response" code="159741000146107" system="http://snomed.info/sct" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.reasoncode" direction="response" code="159731000146104" system="http://snomed.info/sct" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.reasoncode" direction="response" code="404904002" system="http://snomed.info/sct" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.reasoncode" direction="response" code="19829001" system="http://snomed.info/sct" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <!-- protocolApplied -->
        <nts:include value="assert.protocolApplied" direction="response" code="6142004" system="http://snomed.info/sct" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.protocolApplied" direction="response" code="128241005" system="http://snomed.info/sct" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>

            <!-- Test Immunization resource 2 -->

            <!-- Test Immunization resource 3 -->

            <!-- Test Immunization resource 4 -->

            <!-- Test Patient resource -->
            <nts:include value="assert.response.numResources" scope="common" resource="Patient" count="1"/>
            <action>
                <assert>
                    <description value="Test if a patient name use exists of the type 'offical'" />
                    <direction value="response" /> 
                    <expression value= "Bundle.entry.where(resource.is(Patient)).resource.name.where(use = 'official').exists()" />
                </assert>
            </action>
            <action>
                <assert>
                    <description value="Test if a patient name 'Johanna Petronella Maria (Jo) van Putten' exists of the type 'offical'" />
                    <direction value="response" /> 
                    <expression value= "Bundle.entry.where(resource.is(Patient)).resource.name.where(use = 'official').where(text = 'Johanna Petronella Maria (Jo) van Putten').exists()" />
                </assert>
            </action>
            <action>
                <assert>
                    <description value="Test if a patient family name 'van Putten' exists of the type 'offical'" />
                    <direction value="response" /> 
                    <expression value= "Bundle.entry.where(resource.is(Patient)).resource.name.where(use = 'official').where(family = 'van Putten').exists()" />
                </assert>
            </action>
            <action>
                <assert>
                    <description value="Test if a patient with type 'offical' contains three given names " />
                    <direction value="response" /> 
                    <expression value= "Bundle.entry.where(resource.is(Patient)).resource.name.where(use = 'official').given.count() = 3" />
                </assert>
            </action>            
            <action>
                <assert>
                    <description value="Test if a patient given name 'Johanna' exists of the type 'offical'" />
                    <direction value="response" /> 
                    <expression value= "Bundle.entry.where(resource.is(Patient)).resource.name.where(use = 'official').given.where($this = 'Johanna').exists()" />
                </assert>
            </action>
            <action>
                <assert>
                    <description value="Test if a patient given name 'Petronella' exists of the type 'offical'" />
                    <direction value="response" /> 
                    <expression value= "Bundle.entry.where(resource.is(Patient)).resource.name.where(use = 'official').given.where($this = 'Petronella').exists()" />
                </assert>
            </action>
            <action>
                <assert>
                    <description value="Test if a patient given name 'Maria' exists of the type 'offical'" />
                    <direction value="response" /> 
                    <expression value= "Bundle.entry.where(resource.is(Patient)).resource.name.where(use = 'official').given.where($this = 'Maria').exists()" />
                </assert>
            </action>
            <action>
                <assert>
                    <description value="Test if a patient name use exists of the type 'usual'" />
                    <direction value="response" /> 
                    <expression value= "Bundle.entry.where(resource.is(Patient)).resource.name.where(use = 'usual').exists()" />
                </assert>
            </action>
            <action>
                <assert>
                    <description value="Test if a patient given name 'Jo' exists of the type 'usual'" />
                    <direction value="response" /> 
                    <expression value= "Bundle.entry.where(resource.is(Patient)).resource.name.where(use = 'usual').where(given = 'Jo').exists()" />
                </assert>
            </action>
            <action>
                <assert>
                    <description value="Test if a patient with the birthdate '1934-04-28' exists" />
                    <direction value="response" /> 
                    <expression value= "Bundle.entry.resource.as(Patient).birthDate = @1934-04-28"/>
                </assert>
            </action>
            <action>
                <assert>
                    <description value="null meting voor dit type assert" />
                    <direction value="response" /> 
                    <expression value= "Bundle.entry.resource.as(Patient).photo.title = 'Test123'"/>
                </assert>
            </action> 

            <!-- Test Organization resource -->
             <action>
                <assert>
                    <description value="Test if a organization with a URA identifier '32320038' exists" />
                    <direction value="response" /> 
                    <expression value= "Bundle.entry.where(resource.is(Organization)).resource.identifier.where(system = 'http://fhir.nl/fhir/NamingSystem/ura').where(value = '32320038').exists()" />
                </assert>
            </action>
            <action>
                <assert>
                    <description value="Test if a organization with name 'GGD Gelderland-Zuid' exists" />
                    <direction value="response" /> 
                    <expression value= "Bundle.entry.where(resource.is(Organization)).resource.identifier.where(system = 'http://fhir.nl/fhir/NamingSystem/ura').where(value = '32320038').exists()" />
                </assert>
            </action> 

            <!-- Test Organization resource (HealthcareProvider Organisation)-->

            <!-- Test Location resource (HealthcareProvider) -->
            
            <!-- Test Practitioner resource (HealthProfessional Practitioner) -->
            <nts:include value="assert.identifier" direction="request" resource="Practitioner"/>
            <nts:include value="assert.identifier.healthcareprovider" direction="request" resource="Practitioner" system="http://fhir.nl/fhir/NamingSystem/big" code="75131313"/>
            <!-- Test PractitionerRole resource (HealthProfessional PractitionerRole) -->
    </test>

    <!-- Test Medication resource 1 -->
     <test>
        <name value="Scenario 2.1 - Get PharmaceuticalProduct-1"/>
        <description value="Serve PharmaceuticalProduct via an HTTP get."/>
        <action>
            <operation>
                <type>
                    <system value="http://touchstone.aegis.net/touchstone/fhir/testing/CodeSystem/codesystem-testscript-operation-codes"/>
                    <code value="get"/>
                </type>
                <description value="Test XIS server get operation for a document on a known location, using the fullURL."/>
                <destination value="1"/>
                <method value="get"/>
                <origin value="1"/>
                <requestHeader>
                    <field value="Authorization"/>
                    <value value="${patient-token-id}"/>
                </requestHeader>
                <nts:include value="medmij/header.request.MedMijRequestId" scope="common"/>
                <url value="${pharmaceuticalProduct-url-1}"/>
            </operation>
        </action>
        <nts:include value="assert.response.success" scope="common"/>
        <nts:include value="assert.resource.identifier" direction="request" resource="Medication"/>
        <nts:include value="assert.resource.code" direction="request" resource="Medication"/>
        <nts:include value="assert.resource.code.codeableconcept" direction="request" resource="Medication" system="urn:oid:2.16.840.1.113883.2.4.4.10" code="74691"/>
        <nts:include value="assert.resource.form" direction="request" resource="Medication"/>
        <nts:include value="assert.resource.form.codeableconcept" direction="request" resource="Medication" system="urn:oid:2.16.840.1.113883.2.4.4.11" code="44"/>
        <nts:include value="assert.resource.batch" direction="request" resource="Medication"/>
        <nts:include value="assert.resource.batchlotnumber" direction="request" resource="Medication" lotnumber="A21CA260A"/>
    </test>

    <!-- Test Medication resource 2 -->
     <test>
        <name value="Scenario 2.1 - Get PharmaceuticalProduct-2"/>
        <description value="Serve PharmaceuticalProduct via an HTTP get."/>
        <action>
            <operation>
                <type>
                    <system value="http://touchstone.aegis.net/touchstone/fhir/testing/CodeSystem/codesystem-testscript-operation-codes"/>
                    <code value="get"/>
                </type>
                <description value="Test XIS server get operation for a document on a known location, using the fullURL."/>
                <destination value="1"/>
                <method value="get"/>
                <origin value="1"/>
                <requestHeader>
                    <field value="Authorization"/>
                    <value value="${patient-token-id}"/>
                </requestHeader>
                <nts:include value="medmij/header.request.MedMijRequestId" scope="common"/>
                <url value="${pharmaceuticalProduct-url-2}"/>
            </operation>
        </action>
        <nts:include value="assert.response.success" scope="common"/>
        <nts:include value="assert.resource.code" direction="request" resource="Medication"/>
        <nts:include value="assert.resource.code.codeableconcept" direction="request" resource="Medication" system="urn:oid:2.16.840.1.113883.2.4.4.7" code="91804"/>
        <nts:include value="assert.resource.form" direction="request" resource="Medication"/>
        <nts:include value="assert.resource.form.codeableconcept" direction="request" resource="Medication" system="urn:oid:2.16.840.1.113883.2.4.4.11" code="44"/>
        <nts:include value="assert.resource.batch" direction="request" resource="Medication"/>
        <nts:include value="assert.resource.batchlotnumber" direction="request" resource="Medication" lotnumber="20495"/>
        

    </test>

    <!-- Test Medication resource 3 -->
     <test>
        <name value="Scenario 2.1 - Get PharmaceuticalProduct-3"/>
        <description value="Serve PharmaceuticalProduct via an HTTP get."/>
        <action>
            <operation>
                <type>
                    <system value="http://touchstone.aegis.net/touchstone/fhir/testing/CodeSystem/codesystem-testscript-operation-codes"/>
                    <code value="get"/>
                </type>
                <description value="Test XIS server get operation for a document on a known location, using the fullURL."/>
                <destination value="1"/>
                <method value="get"/>
                <origin value="1"/>
                <requestHeader>
                    <field value="Authorization"/>
                    <value value="${patient-token-id}"/>
                </requestHeader>
                <nts:include value="medmij/header.request.MedMijRequestId" scope="common"/>
                <url value="${pharmaceuticalProduct-url-3}"/>
            </operation>
        </action>
        <nts:include value="assert.response.success" scope="common"/>
        <nts:include value="assert.resource.code" direction="request" resource="Medication"/>
        <nts:include value="assert.resource.code.codeableconcept" direction="request" resource="Medication" system="urn:oid:2.16.840.1.113883.2.4.4.7" code="2925508"/>
        <nts:include value="assert.resource.form" direction="request" resource="Medication"/>
        <nts:include value="assert.resource.form.codeableconcept" direction="request" resource="Medication" system="urn:oid:2.16.840.1.113883.2.4.4.11" code="76"/>
        <nts:include value="assert.resource.batch" direction="request" resource="Medication"/>
        <nts:include value="assert.resource.batchlotnumber" direction="request" resource="Medication" lotnumber="ABV3025"/>
    </test>

    <!-- Test Medication resource 4 -->
     <test>
        <name value="Scenario 2.1 - Get PharmaceuticalProduct-4"/>
        <description value="Serve PharmaceuticalProduct via an HTTP get."/>
        <action>
            <operation>
                <type>
                    <system value="http://touchstone.aegis.net/touchstone/fhir/testing/CodeSystem/codesystem-testscript-operation-codes"/>
                    <code value="get"/>
                </type>
                <description value="Test XIS server get operation for a document on a known location, using the fullURL."/>
                <destination value="1"/>
                <method value="get"/>
                <origin value="1"/>
                <requestHeader>
                    <field value="Authorization"/>
                    <value value="${patient-token-id}"/>
                </requestHeader>
                <nts:include value="medmij/header.request.MedMijRequestId" scope="common"/>
                <url value="${pharmaceuticalProduct-url-4}"/>
            </operation>
        </action>
        <nts:include value="assert.response.success" scope="common"/>
        <nts:include value="assert.resource.code" direction="request" resource="Medication"/>
        <nts:include value="assert.resource.code.codeableconcept" direction="request" resource="Medication" system="urn:oid:2.16.840.1.113883.2.4.4.7" code="2924528"/>
        <nts:include value="assert.resource.form" direction="request" resource="Medication"/>
        <nts:include value="assert.resource.form.codeableconcept" direction="request" resource="Medication" system="urn:oid:2.16.840.1.113883.2.4.4.11" code="76"/>
        <nts:include value="assert.resource.batch" direction="request" resource="Medication"/>
        <nts:include value="assert.resource.batchlotnumber" direction="request" resource="Medication" lotnumber="PCA0021"/>
    </test>
</TestScript>