<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://hl7.org/fhir/STU3/testscript.sch" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?>
<TestScript xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript"
    nts:scenario="server">
    <id value="imm-serve-2-1"/>
    <version value="r4-1.0.0"/>
    <name value="Immunization - XIS Server - Scenario 2.1a - Serve Immunization resources of 'van der Voorden-der Teeuwen' with Medication resources"/>
    <description value="Scenario 2.1 - Serve Immunization resources of 'van der Voorden-der Teeuwen'"/>
    <nts:patientTokenFixture href="imm-Patient-05-token.xml"/>

    <nts:include value="variable.immunization.identifier" name="immunization-identifier-01" code="74691" occurrence="2007-04-12T00:00:00+02:00" type="value"/>
    <nts:include value="variable.immunization.identifier" name="immunization-identifier-system-01" code="74691" occurrence="2007-04-12T00:00:00+02:00" type="system"/>
    <nts:include value="variable.immunization.identifier" name="immunization-identifier-02" code="91804" occurrence="2007-04-12T00:00:00+02:00" type="value"/>
    <nts:include value="variable.immunization.identifier" name="immunization-identifier-system-02" code="91804" occurrence="2007-04-12T00:00:00+02:00" type="system"/>
    <nts:include value="variable.immunization.identifier" name="immunization-identifier-03" code="2925508" occurrence="2021-02-19T14:52:00+01:00" type="value"/>
    <nts:include value="variable.immunization.identifier" name="immunization-identifier-system-03" code="2925508" occurrence="2021-02-19T14:52:00+01:00" type="system"/>
    <nts:include value="variable.immunization.identifier" name="immunization-identifier-04" code="2924528" occurrence="2021-12-30T00:00:00+01:00" type="value"/>
    <nts:include value="variable.immunization.identifier" name="immunization-identifier-system-04" code="2924528" occurrence="2021-12-30T00:00:00+01:00" type="system"/>
    
<!--    <variable>
        <name value="pharmaceuticalProduct-url-1"/>
        <!-\- Pick the absolute url as is or create an absolute url when a relative url is given by combining the base url given in the Bundle self link with the relative reference.-\->
        <expression
            value="iif(Bundle.entry.where(resource.is(Immunization)).resource[0].extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference.startsWith('Medication/'),
            Bundle.link.where(relation='self').url.replaceMatches('Immunization[/?].*$','') + Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference,
            Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference)"/>
        <sourceId value="immunization-search-response"/>
    </variable>
    <variable>
        <name value="pharmaceuticalProduct-url-2"/>
        <!-\- Pick the absolute url as is or create an absolute url when a relative url is given by combining the base url given in the Bundle self link with the relative reference.-\->
        <expression
            value="iif(Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference.startsWith('Medication/'),
            Bundle.link.where(relation='self').url.replaceMatches('Immunization[/?].*$','') + Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference,
            Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference)"/>
        <sourceId value="immunization-search-response"/>
    </variable>
    <variable>
        <name value="pharmaceuticalProduct-url-3"/>
        <!-\- Pick the absolute url as is or create an absolute url when a relative url is given by combining the base url given in the Bundle self link with the relative reference.-\->
        <expression
            value="iif(Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference.startsWith('Medication/'),
            Bundle.link.where(relation='self').url.replaceMatches('Immunization[/?].*$','') + Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference,
            Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference)"/>
        <sourceId value="immunization-search-response"/>
    </variable>
    <variable>
        <name value="pharmaceuticalProduct-url-4"/>
        <!-\- Pick the absolute url as is or create an absolute url when a relative url is given by combining the base url given in the Bundle self link with the relative reference.-\->
        <expression
            value="iif(Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference.startsWith('Medication/'),
            Bundle.link.where(relation='self').url.replaceMatches('Immunization[/?].*$','') + Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference,
            Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference)"/>
        <sourceId value="immunization-search-response"/>
    </variable>
-->
    <test>
        <name value="Scenario 2.1 - Get Immunizations"/>
        <description
            value="Serve Immunization resource including the patient"/>
        <nts:include value="medmij/test.xis.successfulSearch" scope="common"
            resource="Immunization"
            params="?_include=Immunization:patient&#38;_include=Immunization:performer"
            responseId="immunization-search-response"/>
        <nts:include value="assert.response.numResources" scope="common"
            resource="Immunization" count="4"/>
        <nts:include value="assert.response.numResources" scope="common"
            resource="Medication" count="4"/>
        <nts:include value="assert.response.numResources" scope="common"
            resource="Patient" count="1"/>

        <nts:include value="assert.numIdentifier" direction="response" resource="Immunization" count="4"/>
        <nts:include value="assert.numMedicationReference" direction="response" resource="Immunization" count="4"/>
        
            <!-- Test Immunization resource 1 -->
<!--        <nts:include value="assert.identifier" direction="response" resource="Immunization"/>
<!-\-        <nts:include value="assert.uniqueidentifier" direction="response" resource="Immunization" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>-\->
        <nts:include value="assert.medicationreference" direction="response" resource="Immunization" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.status" direction="response" resource="Immunization" status="completed" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.vaccincode" direction="response" resource="Immunization" vaccinCode="74691" vaccinCodeSystem="urn:oid:2.16.840.1.113883.2.4.4.10" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.patientreference" direction="response" resource="Immunization" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
<!-\-        <nts:include value="assert.occurence" direction="response" resource="Immunization" occurence="2007-04-12T00:00:00+02:00" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>-\->
        <nts:include value="assert.site" direction="response" resource="Immunization" lateralitycode="7771000" code="40983000" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.route" direction="response" resource="Immunization" code="2" system="urn:oid:2.16.840.1.113883.2.4.4.9" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.dosequantity" direction="response" resource="Immunization" dosevalue="0.5" unit="ml" system="http://unitsofmeasure.org" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.performer" direction="response" resource="Immunization" referenceType="PractitionerRole" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.note" direction="response" resource="Immunization" note="rechterbovenarm in gips" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.reasoncode" direction="response" resource="Immunization" code="159741000146107" system="http://snomed.info/sct" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.reasoncode" direction="response" resource="Immunization" code="159731000146104" system="http://snomed.info/sct" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.reasoncode" direction="response" resource="Immunization" code="404904002" system="http://snomed.info/sct" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.reasoncode" direction="response" resource="Immunization" code="19829001" system="http://snomed.info/sct" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.protocolApplied" direction="response" resource="Immunization" code="6142004" system="http://snomed.info/sct" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>
        <nts:include value="assert.protocolApplied" direction="response" resource="Immunization" code="128241005" system="http://snomed.info/sct" identifier="${immunization-identifier-01}" identifiersystem="${immunization-identifier-system-01}"/>-->
        <!-- Test Immunization resource 2 -->
<!--        <nts:include value="assert.identifier" direction="response" resource="Immunization"/>
<!-\-        <nts:include value="assert.uniqueidentifier" direction="response" resource="Immunization" identifier="${immunization-identifier-02}" identifiersystem="${immunization-identifier-system-02}"/>-\->
        <nts:include value="assert.medicationreference" direction="response" resource="Immunization" identifier="${immunization-identifier-02}" identifiersystem="${immunization-identifier-system-02}"/>
        <nts:include value="assert.status" direction="response" resource="Immunization" status="completed" identifier="${immunization-identifier-02}" identifiersystem="${immunization-identifier-system-02}"/>
        <nts:include value="assert.vaccincode" direction="response" resource="Immunization" vaccinCode="91804" vaccinCodeSystem="urn:oid:2.16.840.1.113883.2.4.4.7" identifier="${immunization-identifier-02}" identifiersystem="${immunization-identifier-system-02}"/>
        <nts:include value="assert.patientreference" direction="response" resource="Immunization" identifier="${immunization-identifier-02}" identifiersystem="${immunization-identifier-system-02}"/>
<!-\-        <nts:include value="assert.occurence" direction="response" resource="Immunization" occurence="2007-04-12T00:00:00+02:00" identifier="${immunization-identifier-02}" identifiersystem="${immunization-identifier-system-02}"/>-\->
        <nts:include value="assert.site" direction="response" resource="Immunization" lateralitycode="24028007" code="40983000" identifier="${immunization-identifier-02}" identifiersystem="${immunization-identifier-system-02}"/>
        <nts:include value="assert.route" direction="response" resource="Immunization" code="2" system="urn:oid:2.16.840.1.113883.2.4.4.9" identifier="${immunization-identifier-02}" identifiersystem="${immunization-identifier-system-02}"/>
        <nts:include value="assert.dosequantity" direction="response" resource="Immunization" dosevalue="0.5" unit="ml" system="http://unitsofmeasure.org" identifier="${immunization-identifier-02}" identifiersystem="${immunization-identifier-system-02}"/>
        <nts:include value="assert.performer" direction="response" resource="Immunization" referenceType="PractitionerRole" identifier="${immunization-identifier-02}" identifiersystem="${immunization-identifier-system-02}"/>
        <nts:include value="assert.note" direction="response" resource="Immunization" note="rechterbovenarm in gips" identifier="${immunization-identifier-02}" identifiersystem="${immunization-identifier-system-02}"/>
        <nts:include value="assert.reasoncode" direction="response" resource="Immunization" code="159721000146101" system="http://snomed.info/sct" identifier="${immunization-identifier-02}" identifiersystem="${immunization-identifier-system-02}"/>
        <nts:include value="assert.reasoncode" direction="response" resource="Immunization" code="33879002" system="http://snomed.info/sct" identifier="${immunization-identifier-02}" identifiersystem="${immunization-identifier-system-02}"/>
        <nts:include value="assert.reasoncode" direction="response" resource="Immunization" code="404904002" system="http://snomed.info/sct" identifier="${immunization-identifier-02}" identifiersystem="${immunization-identifier-system-02}"/>
        <nts:include value="assert.reasoncode" direction="response" resource="Immunization" code="238131007" system="http://snomed.info/sct" identifier="${immunization-identifier-02}" identifiersystem="${immunization-identifier-system-02}"/>
        <nts:include value="assert.protocolApplied" direction="response" resource="Immunization" code="16814004" system="http://snomed.info/sct" identifier="${immunization-identifier-02}" identifiersystem="${immunization-identifier-system-02}"/>-->
        <!-- Test Immunization resource 3 -->
<!--        <nts:include value="assert.identifier" direction="response" resource="Immunization"/>
<!-\-        <nts:include value="assert.uniqueidentifier" direction="response" resource="Immunization" identifier="${immunization-identifier-03}" identifiersystem="${immunization-identifier-system-03}"/>-\->
        <nts:include value="assert.medicationreference" direction="response" resource="Immunization" identifier="${immunization-identifier-03}" identifiersystem="${immunization-identifier-system-03}"/>
        <nts:include value="assert.status" direction="response" resource="Immunization" status="completed" identifier="${immunization-identifier-03}" identifiersystem="${immunization-identifier-system-03}"/>
        <nts:include value="assert.vaccincode" direction="response" resource="Immunization" vaccinCode="2925508" vaccinCodeSystem="urn:oid:2.16.840.1.113883.2.4.4.7" identifier="${immunization-identifier-03}" identifiersystem="${immunization-identifier-system-03}"/>
        <nts:include value="assert.patientreference" direction="response" resource="Immunization" identifier="${immunization-identifier-03}" identifiersystem="${immunization-identifier-system-03}"/>
<!-\-        <nts:include value="assert.occurence" direction="response" resource="Immunization" occurence="2021-02-19T14:52:00+01:00" identifier="${immunization-identifier-03}" identifiersystem="${immunization-identifier-system-03}"/>-\->
        <nts:include value="assert.site" direction="response" resource="Immunization" lateralitycode="7771000" code="40983000" identifier="${immunization-identifier-03}" identifiersystem="${immunization-identifier-system-03}"/>
        <nts:include value="assert.route" direction="response" resource="Immunization" code="2" system="urn:oid:2.16.840.1.113883.2.4.4.9" identifier="${immunization-identifier-03}" identifiersystem="${immunization-identifier-system-03}"/>
        <nts:include value="assert.dosequantity" direction="response" resource="Immunization" dosevalue="0.5" unit="ml" system="http://unitsofmeasure.org" identifier="${immunization-identifier-03}" identifiersystem="${immunization-identifier-system-03}"/>
        <nts:include value="assert.performer" direction="response" resource="Immunization" referenceType="PractitionerRole" identifier="${immunization-identifier-03}" identifiersystem="${immunization-identifier-system-03}"/>
        <nts:include value="assert.note" direction="response" resource="Immunization" note="rechterbovenarm in gips" identifier="${immunization-identifier-03}" identifiersystem="${immunization-identifier-system-03}"/>
        <nts:include value="assert.reasoncode" direction="response" resource="Immunization" code="51116004" system="http://snomed.info/sct" identifier="${immunization-identifier-03}" identifiersystem="${immunization-identifier-system-03}"/>
        <nts:include value="assert.reasoncode" direction="response" resource="Immunization" code="14747002" system="http://snomed.info/sct" identifier="${immunization-identifier-03}" identifiersystem="${immunization-identifier-system-03}"/>
        <nts:include value="assert.reasoncode" direction="response" resource="Immunization" code="238131007" system="http://snomed.info/sct" identifier="${immunization-identifier-03}" identifiersystem="${immunization-identifier-system-03}"/>
        <nts:include value="assert.reasoncode" direction="response" resource="Immunization" code="234532001" system="http://snomed.info/sct" identifier="${immunization-identifier-03}" identifiersystem="${immunization-identifier-system-03}"/>
        <nts:include value="assert.protocolApplied" direction="response" resource="Immunization" code="840539006" system="http://snomed.info/sct" identifier="${immunization-identifier-03}" identifiersystem="${immunization-identifier-system-03}"/>-->
        <!-- Test Immunization resource 4 -->
<!--        <nts:include value="assert.identifier" direction="response" resource="Immunization"/>
<!-\-        <nts:include value="assert.uniqueidentifier" direction="response" resource="Immunization" identifier="${immunization-identifier-04}" identifiersystem="${immunization-identifier-system-04}"/>-\->
        <nts:include value="assert.medicationreference" direction="response" resource="Immunization" identifier="${immunization-identifier-04}" identifiersystem="${immunization-identifier-system-04}"/>
        <nts:include value="assert.status" direction="response" resource="Immunization" status="completed" identifier="${immunization-identifier-04}" identifiersystem="${immunization-identifier-system-04}"/>
        <nts:include value="assert.vaccincode" direction="response" resource="Immunization" vaccinCode="2924528" vaccinCodeSystem="urn:oid:2.16.840.1.113883.2.4.4.7" identifier="${immunization-identifier-04}" identifiersystem="${immunization-identifier-system-04}"/>
        <nts:include value="assert.patientreference" direction="response" resource="Immunization" identifier="${immunization-identifier-04}" identifiersystem="${immunization-identifier-system-04}"/>
<!-\-        <nts:include value="assert.occurence" direction="response" resource="Immunization" occurence="2021-12-30T00:00:00+01:00" identifier="${immunization-identifier-04}" identifiersystem="${immunization-identifier-system-04}"/>-\->
        <nts:include value="assert.site" direction="response" resource="Immunization" lateralitycode="7771000" code="68367000" identifier="${immunization-identifier-04}" identifiersystem="${immunization-identifier-system-04}"/>
        <nts:include value="assert.route" direction="response" resource="Immunization" code="2" system="urn:oid:2.16.840.1.113883.2.4.4.9" identifier="${immunization-identifier-04}" identifiersystem="${immunization-identifier-system-04}"/>
        <nts:include value="assert.dosequantity" direction="response" resource="Immunization" dosevalue="0.3" unit="ml" system="http://unitsofmeasure.org" identifier="${immunization-identifier-04}" identifiersystem="${immunization-identifier-system-04}"/>
        <nts:include value="assert.performer" direction="response" resource="Immunization" referenceType="PractitionerRole" identifier="${immunization-identifier-04}" identifiersystem="${immunization-identifier-system-04}"/>
        <nts:include value="assert.note" direction="response" resource="Immunization" note="intramusculair" identifier="${immunization-identifier-04}" identifiersystem="${immunization-identifier-system-04}"/>
        <nts:include value="assert.reasoncode" direction="response" resource="Immunization" code="159741000146107" system="http://snomed.info/sct" identifier="${immunization-identifier-04}" identifiersystem="${immunization-identifier-system-04}"/>
        <nts:include value="assert.reasoncode" direction="response" resource="Immunization" code="159721000146101" system="http://snomed.info/sct" identifier="${immunization-identifier-04}" identifiersystem="${immunization-identifier-system-04}"/>
        <nts:include value="assert.reasoncode" direction="response" resource="Immunization" code="77386006" system="http://snomed.info/sct" identifier="${immunization-identifier-04}" identifiersystem="${immunization-identifier-system-04}"/>
        <nts:include value="assert.reasoncode" direction="response" resource="Immunization" code="416462003" system="http://snomed.info/sct" identifier="${immunization-identifier-04}" identifiersystem="${immunization-identifier-system-04}"/>
        <nts:include value="assert.protocolApplied" direction="response" resource="Immunization" code="840539006" system="http://snomed.info/sct" identifier="${immunization-identifier-04}" identifiersystem="${immunization-identifier-system-04}"/>-->

        <!-- Patient -->
        <nts:include value="assert.birthdate" direction="response" resource="Patient" date="2004-11-12"/>

    </test>

</TestScript>
