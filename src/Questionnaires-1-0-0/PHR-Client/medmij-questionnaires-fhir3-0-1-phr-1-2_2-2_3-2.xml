<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="../../general/schematron/NictizTestScript.sch" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?>
<TestScript xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript" nts:scenario="client">
    <id value="medmij-questionnaires-fhir3-0-1-phr-1.2-2.2-3.2"/>
    <name value="MedMij Questionnaires - PHR Client - Scenario 1.1, 2.1, 3.1"/>
    <description value="MedMij Questionnaires for FHIR STU3 - PHR Client - Scenario 1.2, 2.2, 3.2 - Retrieve QuestionnaireProvisioningTask, retrieve Questionnaire, and send QuestionnaireResponse"/>
    
    <nts:patientTokenFixture href="medmij-questionnaires-fhir3-0-1-nl-core-patient-VERKEULEN-token.xml"/>
    <nts:fixture id="task-requested-fixture" href="resources/resources-specific/medmij-questionnaires-fhir3-0-1-vl-QuestionnaireProvisioningTask-Verkeulen-PHQ9-REQUESTED.xml"/>
    <nts:fixture id="task-update-fixture" href="resources/resources-specific/medmij-questionnaires-fhir3-0-1-vl-QuestionnaireProvisioningTask-Verkeulen-PHQ9-ACCEPTED.xml"/>
    <nts:fixture id="task-minimum-fixture-xml" href="resources/resources-specific/medmij-questionnaires-fhir3-0-1-vl-QuestionnaireProvisioningTask-Verkeulen-PHQ9-minimum.xml"/>
    <nts:fixture id="task-minimum-fixture-json" href="resources/resources-specific/medmij-questionnaires-fhir3-0-1-vl-QuestionnaireProvisioningTask-Verkeulen-PHQ9-minimum.json"/>
    <nts:fixture id="questionnaire-fixture" href="resources/resources-questionnaires/medmij-questionnaires-fhir3-0-1-vl-Questionnaire-PHQ-9.xml"/>
    <nts:fixture id="response-bundle-fixture" href="resources/resources-specific/medmij-questionnaires-fhir3-0-1-vl-Transaction-Verkeulen-PHQ9.xml"/>
       
    <nts:include value="phr-variables-happyFlow"/>
    <nts:includeDateT value="yes"/>
    
    <setup>
        <nts:include value="phr-setup-checkForOpenTasks"/>
        <nts:include value="phr-setup-createTask"/>
    </setup>
    
    <test id="Scenario1.2-SearchTask">
        <name value="Scenario1.2 - Search QuestionnaireProvisioningTask(s) for patient 1"/>
        <description value="Test PHR client to search for QuestionnaireProvisioningTasks with status 'requested'. The return value should be a Bundle with a single entry."/>
        <nts:include value="phr-scenario1-searchTask"/>
    </test>
    <test id="Scenario2.2-RetrieveQuestionnaire">
        <name value="Scenario2.1 - Retrieve Questionnaire"/>
        <description value="Test PHR client to retrieve the Questionnaire resource specified in the QuestionnaireProvisioningTask.output:Questionnaire.reference. This should be a single GET on the Questionnaire resource."/>
        <nts:include value="phr-scenario2-retrieveQuestionnaire"/>
    </test>
    <test id="Scenario3.2-part1-SendQuestionnaireResponse">
        <name value="Scenario3.2 - Part 1 - Accept QuestionnaireProvisioningTask"/>
        <description value="Test PHR client to send an update of the QuestionnaireProvisioningTask with status='accepted'. The body of the request should otherwise be the same as the original Task as received from the server."/>
        <nts:include value="phr-scenario3-acceptTaskUpdate"/>
    </test>
    <test id="Scenario3.2-part2-SendQuestionnaireResponse">
        <name value="Scenario3.2 - Part 2 - Send QuestionnaireResponse"/>
        <description value="Test PHR client to complete the QuestionnaireProvisioningTask with a QuestionnaireResponse instance. This should be a transaction where Task status is set to 'completed', the QuestionnaireResponse is created and the QuestionnaireResponse is linked in Task.output."/>
        <nts:include value="phr-scenario3-handleTransaction"/>
        
        <action>
            <assert>
                <description value="Confirm that the first linkId value is 'phq9'"/>
                <direction value="request"/>
                <expression value="entry.where(resource as QuestionnaireResponse).resource.item.where(linkId = 'phq-9').exists()"/>
            </assert>
        </action>
        <action>
            <assert>
                <description value="Confirm that the number of second level linkId items matches the Questionnaire 'PHQ-9'"/>
                <direction value="request"/>
                <expression value="entry.where(resource as QuestionnaireResponse).resource.item.item.linkId.count()"/>
            </assert>
        </action>
    </test>
    
    <teardown>
        <nts:include value="phr-teardown-deleteTask"/>
        <nts:include value="phr-teardown-deleteQuestionnaireResponse"/>
    </teardown>
</TestScript>
