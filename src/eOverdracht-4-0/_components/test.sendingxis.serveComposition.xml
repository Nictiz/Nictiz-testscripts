<?xml version="1.0" encoding="UTF-8"?>
<!--
    The step in the eOverdracht flow where the receiving XIS reads a Compostion which is referred to using the .input
    of a previously retrieved Task.
    Please note: this sidesteps the common component "assert.response.bundleContent" because there's a bug in the
    Touchstone validator which produces a torrent of incorrect error messages (see
    https://bits.nictiz.nl/browse/TOUCH-320). As a workaround, the error messages are filtered using a set of Groovy
    rules until this error is resolved.
    @param taskFixtureId - The fixture id of the Task that refers the Composition.
    @param sliceSystem - The system used for the Task.input slice that refers to the Composition.
    @param sliceCode - The code used for the Task.input slice that refers to the Composition.
-->
<nts:component xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript">
    <variable>
        <name value="{$taskFixtureId}-composition-{$sliceCode}-id"/>
        <expression value="Task.input.where(type.where(coding.where(system = '{$sliceSystem}' and code = '{$sliceCode}'))).value.reference.replace('Composition/', '')"/>
        <sourceId value="{$taskFixtureId}"/>
    </variable>
    
    <nts:include value="test.server.successfulRead" scope="common"
        resource="Composition"
        params="/${{$taskFixtureId}-composition-{$sliceCode}-id}/$document"
        useToken="true"/>

    <nts:include value="_assert.response.bundleContent" scope="common"
        bundleType="document"/>
    <nts:include value="_assert.general.bundleContent-core" scope="common"
        direction="response"/>
    <action>
        <assert>
            <nts:rule id="validate-response" href="rules/validate-response-step1.groovy">
                <nts:output name="validationErrors" type="document" contentType="text/plain"/>
                <nts:output name="validationWarnings" type="document" contentType="text/plain"/>
            </nts:rule>
        </assert> 
    </action>
    <action>
        <assert>
            <nts:rule id="analyze-validation-output" href="rules/validate-response-step2.groovy" />
        </assert> 
    </action>
    <nts:include value="_assert.general.resourceContent" scope="common" resourceBase="Bundle"
        direction="response"/>

</nts:component>