<?xml version="1.0" encoding="UTF-8"?>
<TestScript xmlns:nts="http://nictiz.nl/xsl/testscript" xmlns="http://hl7.org/fhir">
   <id value="mp9-ta-serve-0-1-contentAsserts-xml"/>
   <meta>
      <profile value="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript"/>
   </meta>
   <url value="http://nictiz.nl/fhir/TestScript/mp9-ta-serve-0-1-contentAsserts-xml"/>
   <version value="r4-mp9-3.0.0-beta"/>
   <name value="Medication Process 9 3.0.0-beta  - AdministrationAgreement - Serve - Scenario 0.1 - target contentAsserts - XML Format"/>
   <status value="active"/>
   <publisher value="Nictiz"/>
   <contact>
      <name value="Nictiz"/>
      <telecom>
         <system value="email"/>
         <value value="kwalificatie@nictiz.nl"/>
         <use value="work"/>
      </telecom>
   </contact>
   <description value="Scenario 0.1 - Alle toedieningsafspraken van de patiënt, zonder aanvullend filtercriterium (Antwoord: bericht met 6 toedieningsafspraken)"/>
   <origin>
      <index value="1"/>
      <profile>
         <system value="http://terminology.hl7.org/CodeSystem/testscript-profile-origin-types"/>
         <code value="FHIR-Client"/>
      </profile>
   </origin>
   <destination>
      <index value="1"/>
      <profile>
         <system value="http://terminology.hl7.org/CodeSystem/testscript-profile-destination-types"/>
         <code value="FHIR-Server"/>
      </profile>
   </destination>
   <profile id="Bundle-profile">
      <reference value="http://hl7.org/fhir/StructureDefinition/Bundle"/>
   </profile>
   <variable>
      <name value="ta1-id"/>
      <expression value="Bundle.entry.select(resource as MedicationDispense).where(medication.resolve().code.coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.4.7' and code = '641898')).id"/>
      <sourceId value="search-response"/>
   </variable>
   <variable>
      <name value="ta2-id"/>
      <expression value="Bundle.entry.select(resource as MedicationDispense).where(medication.resolve().code.coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.4.7' and code = '101079')).id"/>
      <sourceId value="search-response"/>
   </variable>
   <test id="Scenario-0-1">
      <name value="Scenario 0.1"/>
      <description value="Alle toedieningsafspraken van de patiënt, zonder aanvullend filtercriterium (Antwoord: bericht met 6 toedieningsafspraken)"/>
      <action>
         <operation>
            <type>
               <system value="http://terminology.hl7.org/CodeSystem/testscript-operation-codes"/>
               <code value="search"/>
            </type>
            <resource value="MedicationDispense"/>
            <description value="Test server to serve MedicationDispense resource(s) representing MP9 building block AdministrationAgreement"/>
            <accept value="xml"/>
            <destination value="1"/>
            <encodeRequestUrl value="true"/>
            <origin value="1"/>
            <params value="?patient.identifier=http://fhir.nl/fhir/NamingSystem/bsn|999901084&amp;category=http://snomed.info/sct|422037009&amp;_include=MedicationDispense:medication"/>
            <responseId value="search-response"/>
         </operation>
      </action>
      <!-- Removed for brevity -->
   </test>
   <test id="Scenario-0-1-id">
      <name value="Scenario 0.1 - identify resources"/>
      <description value="Probeer alle opgehaalde resources te koppelen aan resources zoals die volgens het testscenario verwacht worden"/>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="affirmTA1"/>
            <description value="Confirm that the response Bundle contains 1 MedicationDispense resource that references Medication 641898|urn:oid:2.16.840.1.113883.2.4.4.7 (IBUPROFEN PCH TABLET 600MG)"/>
            <expression value="Bundle.entry.select(resource as MedicationDispense).where(medication.resolve().code.coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.4.7' and code = '641898')).count() = 1"/>
            <sourceId value="search-response"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="affirmTA2"/>
            <description value="Confirm that the response Bundle contains 1 MedicationDispense resource that references Medication 101079|urn:oid:2.16.840.1.113883.2.4.4.7 (XPRAEP SIROOP 2MG/ML)"/>
            <expression value="Bundle.entry.select(resource as MedicationDispense).where(medication.resolve().code.coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.4.7' and code = '101079')).count() = 1"/>
            <sourceId value="search-response"/>
            <warningOnly value="false"/>
         </assert>
      </action>
   </test>
   <test id="Scenario-0-1-TA1-check">
      <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-test-startTestOnPass">
         <valueString value="assertTA1"/>
      </extension>
      <name value="Scenario 0.1 - check content of TA1"/>
      <description value="Controleer of de inhoud van ToedieningAfspraak1 voldoet aan de verwachtingen."/>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-assertOnPass">
               <valueString value="assertTA1"/>
            </extension>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that ToedieningAfspraak1 contains category 422037009|http://snomed.info/sct (toedieningsafspraak)"/>
            <expression value="Bundle.entry.select(resource as MedicationDispense).where(id = '${ta1-id}').category.coding.where(system = 'http://snomed.info/sct' and code = '422037009').exists()"/>
            <sourceId value="search-response"/>
            <warningOnly value="false"/>
         </assert>
      </action>
   </test>
</TestScript>
