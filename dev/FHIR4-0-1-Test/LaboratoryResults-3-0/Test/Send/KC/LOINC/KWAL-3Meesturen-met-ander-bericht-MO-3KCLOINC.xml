<?xml version="1.0" encoding="UTF-8"?>
<TestScript xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript">
   <id value="KWAL-l2z-7Meesturen-met-ander-bericht-MO-3AKCLOINCLosresultaat"/>
   <meta>
      <profile value="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript"/>
   </meta>
   <url value="http://nictiz.nl/fhir/TestScript/KWAL-l2z-7Meesturen-met-ander-bericht-MO-3AKCLOINCLosresultaat"/>
   <version value="R4-3.0"/>
   <name value="LaboratoryResults - Meesturen met ander bericht - Scenario 3 KC LOINC."/>
   <status value="active"/>
   <publisher value="Nictiz"/>
   <contact>
      <name value="Nictiz"/>
      <telecom>
         <system value="email"/>
         <value value="kwalificatie@nictiz.nl"/>
         <use value="work"/>
      </telecom>
   </contact>
   <description value="Scenario 3 KC LOINC - Send KC results with a LOINC code."/>
   <origin>
      <index value="1"/>
      <profile>
         <system value="http://terminology.hl7.org/CodeSystem/testscript-profile-origin-types"/>
         <code value="FHIR-Client"/>
      </profile>
   </origin>
   <destination>
      <index value="1"/>
      <profile>
         <system value="http://terminology.hl7.org/CodeSystem/testscript-profile-destination-types"/>
         <code value="FHIR-Server"/>
      </profile>
   </destination>
   <fixture id="KWAL-3-3KCLOINC">
      <autocreate value="false"/>
      <autodelete value="false"/>
      <resource>
         <reference value="../../../_reference/Sending-XIS/lr-slr-KWAL-l2z-3Meesturen-met-ander-bericht-MO-3KCLOINC.xml"/>
      </resource>
   </fixture>
   <variable>
      <name value="T"/>
      <defaultValue value="${CURRENTDATE}"/>
      <description value="Date that data and queries are expected to be relative to."/>
   </variable>
   <test id="Meesturen-met-ander-bericht Scenario 3 KC LOINC">
      <name value="Scenario 3 KC LOINC"/>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the request Bundle contains 4 Observation resource(s). "/>
            <direction value="request"/>
            <expression value="Bundle.entry.where(resource.is(Observation)).count() = 4"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the request Bundle contains 1 Device resource(s). "/>
            <direction value="request"/>
            <expression value="Bundle.entry.where(resource.is(Device)).count() = 1"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the request Bundle contains 1 Specimen resource(s). "/>
            <direction value="request"/>
            <expression value="Bundle.entry.where(resource.is(Specimen)).count() = 1"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the request Bundle contains 1 Organization resource(s). "/>
            <direction value="request"/>
            <expression value="Bundle.entry.where(resource.is(Organization)).count() = 1"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the request Bundle contains 1 Patient resource(s). "/>
            <direction value="request"/>
            <expression value="Bundle.entry.where(resource.is(Patient)).count() = 1"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <!--Asserts for checking the Patient resource -->
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm the Patient resource contains identifier with the BSN system http://fhir.nl/fhir/NamingSystem/bsn and value 999910966."/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Patient).identifier.where(system='http://fhir.nl/fhir/NamingSystem/bsn' and value='999910966').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that Bundle contains the right address (name) for the Patient"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Patient).name.where(use='offical' and text ='H Smit' and family='Smit' and given='H').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that Bundle contains the right name (family) for the Patient"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Patient).name.family.extension.where(url='http://hl7.org/fhir/StructureDefinition/humanname-own-name' and value='Smit').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that Bundle contains the right name (family) for the Patient"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Patient).name.given.extension.where(url='http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier' and value='BR').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the Bundle contains a(n) Patient with the gender"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Patient).gender=@male"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the Bundle contains a(n) Patient with the gender code M with system http://terminology.hl7.org/CodeSystem/v3-AdministrativeGender and a display value"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Patient).gender.extension.where(url='http://nictiz.nl/fhir/StructureDefinition/ext-CodeSpecification' and valueCodeableConcept.coding.system='http://terminology.hl7.org/CodeSystem/v3-AdministrativeGender' and valueCodeableConcept.coding.code='M' and extension.valueCodeableConcept.coding.display.exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Evaluate Patient.birthDate equivalent against variable 'date' date value"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Patient).birthDate ~ @${date}"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <!-- Asserts for checking the Observation resource -->
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm the Observation resource contains an identifier"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Observation).identifier.exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the Bundle contains a(n) Observation that has the status final."/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Observation).where(status='final').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the Bundle contains a(n) Observation that has the code 62238-1 with system http://loinc.org"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Observation).code.coding.where(code='62238-1' and system='http://loinc.org' and display.exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the Bundle contains a(n) Observation with a value of 25, and system http://unitsofmeasure.org and a unit."/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Observation).valueQuantity.where(value=25 and system='http://unitsofmeasure.org' and code='mL/min/{1.73_m2}' and unit.exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the Bundle contains a(n) Observation with the interpretation Waarde is te laag. Stadum 4 nierfalen, ernstige nierfunctiestoornis."/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Observation).where(interpretation.text~'Waarde is te laag. Stadum 4 nierfalen, ernstige nierfunctiestoornis.').exists()"/>
            <warningOnly value="true"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the Bundle contains a(n) Observation that has a reference range of value."/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Observation).referenceRange.low.where(value='90' and system='http://unitsofmeasure.org' and code='mL/min/{1.73_m2}' and unit.exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <!-- Asserts for checking the Specimen resource -->
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm the Specimen resource contains an identifier"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Specimen).identifier.exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the Bundle contains the right type for the Specimen"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Specimen).type.coding.where(system='http://snomed.info/sct' and code='122575003' and display.exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm the Specimen resource contains the note Urine ingeleverd door patiënt.."/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Specimen).note.where(text='Urine ingeleverd door patiënt.').exists()"/>
            <warningOnly value="true"/>
         </assert>
      </action>
      <!-- Asserts for checking the Organization resource -->
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm the Organization resource contains an identifier"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Organization).identifier.exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the Bundle contains the right type for the Organization"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Organization).type.coding.where(system='http://nictiz.nl/fhir/NamingSystem/organization-type' and code='L1' and display.exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the Bundle contains name"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Organization).name.where(value=Klinisch chemisch Lab 't Proefje').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm the Bundle contains the right telecom (email/phone) information for Organization"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Organization).telecom.where(system= 'phone' and value ='06-11122233' and use='work').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that Bundle contains the right telecom comment for the Organization"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Organization).telecom.extension.where(url='http://nictiz.nl/fhir/StructureDefinition/ext-Comment' and value ='Bel met vragen').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm the Bundle contains the right telecom (email/phone) information for Organization"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Organization).telecom.where(system= 'email' and value ='tproefje@lab.nl' and use='work').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that Bundle contains the right telecom comment for the Organization"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Organization).telecom.extension.where(url='' and value ='').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that Bundle contains the right address (street) for the Organization"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Organization).address.line.extension.where(url='http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-streetName' and value='Hoofdstraat').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that Bundle contains the right address (house number) for the Organization"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Organization).address.line.extension.where(url='http://hl7.org/fhir/StructureDefinition/iso21090-ADXP-houseNumber' and value ='23').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that Bundle contains the right building suffix number for the Organization"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Organization).address.line.extension.where(url='' and value ='').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that Bundle contains the right address (city and postal code) for the Organization"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Organization).address.where(city='Zorgstad' and postalCode='1234AA' use='work').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that Bundle contains the right address (type) for the Organization"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.as(Organization).address.extension.where(url='http://nictiz.nl/fhir/StructureDefinition/ext-AddressInformation.AddressType').value.coding.where(system='http://terminology.hl7.org/CodeSystem/v3-AddressUse' and code='WP' and display.exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
   </test>
</TestScript>
