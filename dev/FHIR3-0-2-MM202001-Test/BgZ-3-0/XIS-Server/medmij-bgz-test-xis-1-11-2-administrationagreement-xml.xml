<?xml version="1.0" encoding="UTF-8"?>
<TestScript xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript">
   <id value="medmij-bgz-test-xis-1-11-2-xml"/>
   <meta>
      <profile value="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript"/>
   </meta>
   <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-rule">
      <extension url="ruleId">
         <valueId value="assert-response-queryParamsInSelfLink"/>
      </extension>
      <extension url="path">
         <valueString value="../_reference/rules/assert_response_queryParamsInSelfLink.groovy"/>
      </extension>
   </extension>
   <url value="http://nictiz.nl/fhir/TestScript/medmij-bgz-test-xis-1-11-2-xml"/>
   <version value="stu3-3.0-patchlevel 2023-10"/>
   <name value="BgZ - XIS Server - Test - Scenario 1.11.2 - Serve BgZ AdministrationAgreement resources of XXX_Rijn - XML Format"/>
   <status value="active"/>
   <publisher value="Nictiz"/>
   <contact>
      <name value="Nictiz"/>
      <telecom>
         <system value="email"/>
         <value value="kwalificatie@nictiz.nl"/>
         <use value="work"/>
      </telecom>
   </contact>
   <description value="Scenario 1.11.2 - Serve BgZ AdministrationAgreement resources of XXX_Rijn"/>
   <origin>
      <index value="1"/>
      <profile>
         <system value="http://terminology.hl7.org/CodeSystem/testscript-profile-origin-types"/>
         <code value="FHIR-Client"/>
      </profile>
   </origin>
   <destination>
      <index value="1"/>
      <profile>
         <system value="http://terminology.hl7.org/CodeSystem/testscript-profile-destination-types"/>
         <code value="FHIR-Server"/>
      </profile>
   </destination>
   <profile id="Bundle-profile">
      <reference value="http://hl7.org/fhir/StructureDefinition/Bundle"/>
   </profile>
   <variable>
      <name value="patient-token-id"/>
      <defaultValue value="Bearer 7ce7c666-6f96-40a7-a8fa-922056cb18b4"/>
      <description value="OAuth Token for current patient"/>
   </variable>
   <variable>
      <name value="zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id"/>
      <description value="Resource.id for MedicationDispense 1"/>
      <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(modifierExtension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/zib-Medication-StopType').value.ofType(CodeableConcept).where(coding.where(code = '1'))).id"/>
      <sourceId value="fixture-response"/>
   </variable>
   <variable>
      <name value="zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id"/>
      <description value="Resource.id for MedicationDispense 2"/>
      <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(modifierExtension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/zib-Medication-StopType').value.ofType(CodeableConcept).where(coding.where(code = '2'))).id"/>
      <sourceId value="fixture-response"/>
   </variable>
   <variable>
      <name value="zib-Product-medmij-bgz-test-patA-product1-id"/>
      <description value="Resource.id for Medication 1"/>
      <expression value="Bundle.entry.resource.ofType(Medication).where(code.where(coding.where(code = '2182416'))).id"/>
      <sourceId value="fixture-response"/>
   </variable>
   <variable>
      <name value="zib-Product-medmij-bgz-test-patA-product2-id"/>
      <description value="Resource.id for Medication 2"/>
      <expression value="Bundle.entry.resource.ofType(Medication).where(code.where(coding.where(code = '2613093'))).id"/>
      <sourceId value="fixture-response"/>
   </variable>
   <test>
      <name value="Scenario 1.11.2 - AdministrationAgreement"/>
      <description value="Serve MedicationDispense resource(s) for zib AdministrationAgreement and include Medication"/>
      <action>
         <operation>
            <type>
               <system value="http://terminology.hl7.org/CodeSystem/testscript-operation-codes"/>
               <code value="search"/>
            </type>
            <resource value="MedicationDispense"/>
            <description value="Test XIS server to serve MedicationDispense resources."/>
            <accept value="xml"/>
            <destination value="1"/>
            <encodeRequestUrl value="true"/>
            <origin value="1"/>
            <params value="?category=http://snomed.info/sct|422037009&amp;_include=MedicationDispense:medication"/>
            <requestHeader>
               <field value="Authorization"/>
               <value value="${patient-token-id}"/>
            </requestHeader>
            <requestHeader>
               <field value="MedMij-Request-ID"/>
               <value value="${UUID}"/>
            </requestHeader>
            <responseId value="fixture-response"/>
         </operation>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="Confirm that the operation was successful"/>
            <operator value="in"/>
            <responseCode value="200,201"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the returned resource type is Bundle."/>
            <direction value="response"/>
            <resource value="Bundle"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the returned Bundle type is searchset."/>
            <direction value="response"/>
            <expression value="Bundle.type"/>
            <operator value="equals"/>
            <value value="searchset"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all returned resources contain an Resource.id except when temporary ids are used in the Bundle. The only time that a resource does not have an id is when it is being submitted to the server using a create operation: https://www.hl7.org/fhir/STU3/resource-definitions.html#Resource.id "/>
            <direction value="response"/>
            <expression value="Bundle.entry.all( $this.fullUrl.matches('^urn:oid:[0-2](\\.(0|[1-9]\\d*))*$') or $this.fullUrl.matches('^urn:uuid:[A-Fa-f\\d]{8}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{12}$') or $this.resource.id.exists())"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all returned resources except OperationOutcome and Binary contain a meta.profile tag."/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.where(is(OperationOutcome).not()).where(is(Binary).not()).where(meta.profile.empty()).empty()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the fullUrl does not disagree with the id in the resource, see http://hl7.org/fhir/stu3/bundle-definitions.html#Bundle.entry.fullUrl"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(fullUrl.exists() and resource.id.exists()).all($this.fullUrl.endsWith($this.resource.id))"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the fullUrl is an absolute URL, an uuid or an oid."/>
            <direction value="response"/>
            <expression value="Bundle.entry.fullUrl.all( startsWith('http://') or startsWith('https://') or matches('^urn:oid:[0-2](\\.(0|[1-9]\\d*))*$') or matches('^urn:uuid:[A-Fa-f\\d]{8}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{12}$') )"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the returned Bundle conforms to the base FHIR specification and the resources to the stated profiles in the meta.profile tag."/>
            <direction value="response"/>
            <validateProfileId value="Bundle-profile"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all coding elements contain both a .system and a .code."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().where($this.is(coding)).all(system.exists() and code.exists())"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the OID of the zib valueset is not used for the system of a coding element."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().where($this.is(coding)).system.startsWith('urn:oid:2.16.840.1.113883.2.4.3.11.60.40.2').not()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all CodeableConcept elements contain either a coding.display or a text value if no Coding exists or has an extension (e.g. a nullFlavor or data-absent-reason extension). For more information see https://informatiestandaarden.nictiz.nl/wiki/FHIR:V1.0_FHIR_IG_STU3Use_of_coded_concepts."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().where($this.is(CodeableConcept)) .all(coding.display.exists() or text.exists() or extension.exists())"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all References have a display value, see https://informatiestandaarden.nictiz.nl/wiki/FHIR:V1.0_FHIR_IG_STU3#Use_of_the_reference_datatype."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().where($this.is(Reference)).all(display.exists() or extension.where(url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason').exists() or extension.where(url = 'http://hl7.org/fhir/StructureDefinition/iso21090-nullFlavor').exists())"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all Identifiers have both a .system and a .value. In rare cases where a general category of identifiers can be used, .type can replace .system. Edge cases for both .system and .type to be unknown are not applicable to Nictiz. For more information, see https://www.hl7.org/fhir/stu3/datatypes.html#Identifier."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().where($this.is(Identifier)).all((system.exists() or type.exists()) and value.exists())"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that Bundle does not use Burgerservicenummer (BSN) anywhere."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().select(identifier.where(system = 'http://fhir.nl/fhir/NamingSystem/bsn').where(value.empty().not() and value.extension.exists().not())).count() = 0"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the returned Bundle total value matches or is less than the number of entries in the Bundle. The included resources should not be counted as entries in the Bundle.total."/>
            <direction value="response"/>
            <expression value="Bundle.total.toInteger() &lt;= Bundle.entry.where(search.empty() or search.mode = 'match').count()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the returned Bundle contains a self link."/>
            <direction value="response"/>
            <expression value="Bundle.link.where(relation = 'self' and url.exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that Bundle does not use Burgerservicenummer (BSN) in the self link."/>
            <direction value="response"/>
            <expression value="Bundle.link.url.contains('http://fhir.nl/fhir/NamingSystem/bsn') = false"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-rule">
               <extension url="ruleId">
                  <valueId value="assert-response-queryParamsInSelfLink"/>
               </extension>
            </extension>
            <warningOnly value="true"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the response Bundle contains 2 MedicationDispense resource(s). "/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(MedicationDispense)).count() = 2"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the response Bundle contains 2 Medication resource(s). "/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Medication)).count() = 2"/>
            <warningOnly value="false"/>
         </assert>
      </action>
   </test>
   <test>
      <name value="Scenario 1.11.2 - AdministrationAgreement - Check MedicationDispense 1"/>
      <description value="Check if the previous operation results in a FHIR MedicationDispense that contains the values that are expected following Nictiz' materials (fixture .id: zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1)"/>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="Response Bundle contains exactly 1 MedicationDispense that contains .modifierExtension('http://nictiz.nl/fhir/StructureDefinition/zib-Medication-StopType') with .valueCodeableConcept.coding.code = '1'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(modifierExtension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/zib-Medication-StopType').value.ofType(CodeableConcept).where(coding.where(code = '1'))).count() = 1"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="MedicationDispense resource evaluated in the previous assert contains an .id"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(modifierExtension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/zib-Medication-StopType').value.ofType(CodeableConcept).where(coding.where(code = '1'))).id.exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-1"/>
            <description value="Contains .meta with .profile 'http://nictiz.nl/fhir/StructureDefinition/zib-AdministrationAgreement'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').meta.profile.where($this = 'http://nictiz.nl/fhir/StructureDefinition/zib-AdministrationAgreement').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-2"/>
            <description value="Contains .extension with url 'http://nictiz.nl/fhir/StructureDefinition/zib-AdministrationAgreement-AuthoredOn' with .valueDateTime"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').extension('http://nictiz.nl/fhir/StructureDefinition/zib-AdministrationAgreement-AuthoredOn').value.ofType(dateTime).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-3"/>
            <description value="Contains .extension with url 'http://nictiz.nl/fhir/StructureDefinition/zib-AdministrationAgreement-AgreementReason' with .valueString 'Plaatsing Knieprothese'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').extension('http://nictiz.nl/fhir/StructureDefinition/zib-AdministrationAgreement-AgreementReason').value.ofType(string).replaceMatches('[ .,_-]+', ' ') ~ 'Plaatsing Knieprothese'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-4"/>
            <description value="Contains .extension with url 'http://nictiz.nl/fhir/StructureDefinition/zib-Medication-PeriodOfUse' with .valuePeriod with .start"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').extension('http://nictiz.nl/fhir/StructureDefinition/zib-Medication-PeriodOfUse').value.ofType(Period).start.exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-5"/>
            <description value="Contains .extension with url 'http://nictiz.nl/fhir/StructureDefinition/zib-MedicationUse-Duration' with .valueDuration with .value '14' and .unit 'dagen' and .system and .code 'd'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').extension('http://nictiz.nl/fhir/StructureDefinition/zib-MedicationUse-Duration').value.ofType(Duration).where(value = 14 and unit.replaceMatches('[ .,_-]+', ' ') ~ 'dagen' and system and code = 'd').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-6"/>
            <description value="Contains .extension with url 'http://nictiz.nl/fhir/StructureDefinition/zib-Medication-AdditionalInformation' with .valueCodeableConcept with .coding with .system 'urn:oid:2.16.840.1.113883.2.4.3.11.60.20.77.5.2.3.999' and .code '10' and .display"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').extension('http://nictiz.nl/fhir/StructureDefinition/zib-Medication-AdditionalInformation').value.ofType(CodeableConcept).coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.3.11.60.20.77.5.2.3.999' and code = '10' and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-7"/>
            <description value="Contains .modifierExtension with url 'http://nictiz.nl/fhir/StructureDefinition/zib-Medication-StopType' with .valueCodeableConcept with .coding with .system 'urn:oid:2.16.840.1.113883.2.4.3.11.60.20.77.5.2.1' and .code '1' and .display"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').modifierExtension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/zib-Medication-StopType').value.ofType(CodeableConcept).coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.3.11.60.20.77.5.2.1' and code = '1' and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-8"/>
            <description value="Contains .identifier with .system and .value"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').identifier.where(system and value).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-9"/>
            <description value="Contains .status 'completed'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').status = 'completed'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-10"/>
            <description value="Contains .category with .coding with .system 'http://snomed.info/sct' and .code '422037009' and .display"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').category.coding.where(system = 'http://snomed.info/sct' and code = '422037009' and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-11"/>
            <description value="Contains .medicationReference with either .reference or .identifier and .display"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').medication.ofType(Reference).where((reference or identifier) and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-12"/>
            <description value="Contains .subject with either .reference or .identifier and .display"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').subject.where((reference or identifier) and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-13"/>
            <description value="Contains .performer with .actor with .extension with url 'http://nictiz.nl/fhir/StructureDefinition/practitionerrole-reference' with .valueReference with either .reference or .identifier and .display, and with either .reference or .identifier and .display"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').performer.where(actor.where(extension('http://nictiz.nl/fhir/StructureDefinition/practitionerrole-reference').value.ofType(Reference).where((reference or identifier) and display) and (reference or identifier) and display)).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-14"/>
            <description value="Contains .dosageInstruction with .sequence '1' and .text 'Vanaf 28 november, gedurende 14 dagen, 2 maal per dag 1T, oraal' and .timing with .repeat with .boundsDuration with .value '14' and .unit 'dagen' and .system and .code 'd' and .when 'MORN' and .when 'NIGHT' and .route with .coding with .system 'urn:oid:2.16.840.1.113883.2.4.4.9' and .code '9' and .display and .doseQuantity with .value '2.5' and .unit and .system 'urn:oid:2.16.840.1.113883.2.4.4.1.900.2' and .code '229'. This assert checks if all children exist (if applicable with their specific values) and if they are present within one element. Following asserts check if individual children exist to help you debug if this assert fails"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').dosageInstruction.where(sequence = 1 and text.replaceMatches('[ .,_-]+', ' ') ~ 'Vanaf 28 november gedurende 14 dagen 2 maal per dag 1T oraal' and timing.repeat.where(bounds.ofType(Duration).where(value = 14 and unit.replaceMatches('[ .,_-]+', ' ') ~ 'dagen' and system and code = 'd') and when.where($this = 'MORN') and when.where($this = 'NIGHT')) and route.coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.4.9' and code = '9' and display) and dose.ofType(Quantity).where(value = 2.5 and unit and system = 'urn:oid:2.16.840.1.113883.2.4.4.1.900.2' and code = '229')).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-14-1"/>
            <description value="Contains .dosageInstruction.sequence '1'. This assert checks only one child. Assert 1-14 checks if all children are present in the same parent"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').dosageInstruction.where(sequence = 1).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-14-2"/>
            <description value="Contains .dosageInstruction.text 'Vanaf 28 november, gedurende 14 dagen, 2 maal per dag 1T, oraal'. This assert checks only one child. Assert 1-14 checks if all children are present in the same parent. This assert is set to warning because string comparisons can have many possible caveats"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').dosageInstruction.where(text.replaceMatches('[ .,_-]+', ' ') ~ 'Vanaf 28 november gedurende 14 dagen 2 maal per dag 1T oraal').exists()"/>
            <warningOnly value="true"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-14-3"/>
            <description value="Contains .dosageInstruction.timing with .repeat with .boundsDuration with .value '14' and .unit 'dagen' and .system and .code 'd' and .when 'MORN' and .when 'NIGHT'. This assert checks only one child. Assert 1-14 checks if all children are present in the same parent"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').dosageInstruction.where(timing.repeat.where(bounds.ofType(Duration).where(value = 14 and unit.replaceMatches('[ .,_-]+', ' ') ~ 'dagen' and system and code = 'd') and when.where($this = 'MORN') and when.where($this = 'NIGHT')).exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-14-4"/>
            <description value="Contains .dosageInstruction.route with .coding with .system 'urn:oid:2.16.840.1.113883.2.4.4.9' and .code '9' and .display. This assert checks only one child. Assert 1-14 checks if all children are present in the same parent"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').dosageInstruction.where(route.coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.4.9' and code = '9' and display).exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-14-5"/>
            <description value="Contains .dosageInstruction.doseQuantity with .value '2.5' and .unit and .system 'urn:oid:2.16.840.1.113883.2.4.4.1.900.2' and .code '229'. This assert checks only one child. Assert 1-14 checks if all children are present in the same parent"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr1-id}').dosageInstruction.where(dose.ofType(Quantity).where(value = 2.5 and unit and system = 'urn:oid:2.16.840.1.113883.2.4.4.1.900.2' and code = '229').exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
   </test>
   <test>
      <name value="Scenario 1.11.2 - AdministrationAgreement - Check MedicationDispense 2"/>
      <description value="Check if the previous operation results in a FHIR MedicationDispense that contains the values that are expected following Nictiz' materials (fixture .id: zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2)"/>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="Response Bundle contains exactly 1 MedicationDispense that contains .modifierExtension('http://nictiz.nl/fhir/StructureDefinition/zib-Medication-StopType') with .valueCodeableConcept.coding.code = '2'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(modifierExtension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/zib-Medication-StopType').value.ofType(CodeableConcept).where(coding.where(code = '2'))).count() = 1"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="MedicationDispense resource evaluated in the previous assert contains an .id"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(modifierExtension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/zib-Medication-StopType').value.ofType(CodeableConcept).where(coding.where(code = '2'))).id.exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-1"/>
            <description value="Contains .meta with .profile 'http://nictiz.nl/fhir/StructureDefinition/zib-AdministrationAgreement'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').meta.profile.where($this = 'http://nictiz.nl/fhir/StructureDefinition/zib-AdministrationAgreement').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-2"/>
            <description value="Contains .extension with url 'http://nictiz.nl/fhir/StructureDefinition/zib-AdministrationAgreement-AuthoredOn' with .valueDateTime"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').extension('http://nictiz.nl/fhir/StructureDefinition/zib-AdministrationAgreement-AuthoredOn').value.ofType(dateTime).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-3"/>
            <description value="Contains .extension with url 'http://nictiz.nl/fhir/StructureDefinition/zib-AdministrationAgreement-AgreementReason' with .valueString 'Plaatsing Knieprothese'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').extension('http://nictiz.nl/fhir/StructureDefinition/zib-AdministrationAgreement-AgreementReason').value.ofType(string).replaceMatches('[ .,_-]+', ' ') ~ 'Plaatsing Knieprothese'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-4"/>
            <description value="Contains .extension with url 'http://nictiz.nl/fhir/StructureDefinition/zib-Medication-PeriodOfUse' with .valuePeriod with .start and .end"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').extension('http://nictiz.nl/fhir/StructureDefinition/zib-Medication-PeriodOfUse').value.ofType(Period).where(start and end).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-5"/>
            <description value="Contains .extension with url 'http://nictiz.nl/fhir/StructureDefinition/zib-Medication-AdditionalInformation' with .valueCodeableConcept with .coding with .system 'urn:oid:2.16.840.1.113883.2.4.3.11.60.20.77.5.2.3.999' and .code '10' and .display"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').extension('http://nictiz.nl/fhir/StructureDefinition/zib-Medication-AdditionalInformation').value.ofType(CodeableConcept).coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.3.11.60.20.77.5.2.3.999' and code = '10' and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-6"/>
            <description value="Contains .modifierExtension with url 'http://nictiz.nl/fhir/StructureDefinition/zib-Medication-StopType' with .valueCodeableConcept with .coding with .system 'urn:oid:2.16.840.1.113883.2.4.3.11.60.20.77.5.2.1' and .code '2' and .display"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').modifierExtension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/zib-Medication-StopType').value.ofType(CodeableConcept).coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.3.11.60.20.77.5.2.1' and code = '2' and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-7"/>
            <description value="Contains .modifierExtension with url 'http://nictiz.nl/fhir/StructureDefinition/zib-Medication-RepeatPeriodCyclicalSchedule' with .valueDuration with .value '8' and .unit 'dagen' and .system and .code 'd'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').modifierExtension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/zib-Medication-RepeatPeriodCyclicalSchedule').value.ofType(Duration).where(value = 8 and unit.replaceMatches('[ .,_-]+', ' ') ~ 'dagen' and system and code = 'd').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-8"/>
            <description value="Contains .identifier with .system and .value"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').identifier.where(system and value).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-9"/>
            <description value="Contains .status 'completed'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').status = 'completed'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-10"/>
            <description value="Contains .category with .coding with .system 'http://snomed.info/sct' and .code '422037009' and .display"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').category.coding.where(system = 'http://snomed.info/sct' and code = '422037009' and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-11"/>
            <description value="Contains .medicationReference with either .reference or .identifier and .display"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').medication.ofType(Reference).where((reference or identifier) and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-12"/>
            <description value="Contains .subject with either .reference or .identifier and .display"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').subject.where((reference or identifier) and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-13"/>
            <description value="Contains .performer with .actor with .extension with url 'http://nictiz.nl/fhir/StructureDefinition/practitionerrole-reference' with .valueReference with either .reference or .identifier and .display, and with either .reference or .identifier and .display"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').performer.where(actor.where(extension('http://nictiz.nl/fhir/StructureDefinition/practitionerrole-reference').value.ofType(Reference).where((reference or identifier) and display) and (reference or identifier) and display)).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-14"/>
            <description value="Contains .note with .text 'Voor gebruik tot maximaal 3 weken na plaatsing kunstknie'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').note.where(text.replaceMatches('[ .,_-]+', ' ') ~ 'Voor gebruik tot maximaal 3 weken na plaatsing kunstknie').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-15"/>
            <description value="Contains .dosageInstruction with .sequence '1' and .text 'Gedurende 24 dagen, cyclus van 8 dagen: steeds gedurende 7 dagen, elke 4 uur n tablet, zo nodig n tablet extra, oraal' and .additionalInstruction with .text 'Na 7 dagen n dag niet gebruiken' and .timing with .repeat with .boundsDuration with .value '21' and .unit 'dagen' and .system and .code 'd' and .period '4' and .periodUnit 'h' and .route with .coding with .system 'urn:oid:2.16.840.1.113883.2.4.4.9' and .code '9' and .display and .doseQuantity with .value '600' and .unit and .system 'urn:oid:2.16.840.1.113883.2.4.4.1.900.2' and .code '229'. This assert checks if all children exist (if applicable with their specific values) and if they are present within one element. Following asserts check if individual children exist to help you debug if this assert fails"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').dosageInstruction.where(sequence = 1 and text.replaceMatches('[ .,_-]+', ' ') ~ 'Gedurende 24 dagen cyclus van 8 dagen: steeds gedurende 7 dagen elke 4 uur n tablet zo nodig n tablet extra oraal' and additionalInstruction.where(text.replaceMatches('[ .,_-]+', ' ') ~ 'Na 7 dagen n dag niet gebruiken') and timing.repeat.where(bounds.ofType(Duration).where(value = 21 and unit.replaceMatches('[ .,_-]+', ' ') ~ 'dagen' and system and code = 'd') and period = 4 and periodUnit = 'h') and route.coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.4.9' and code = '9' and display) and dose.ofType(Quantity).where(value = 600 and unit and system = 'urn:oid:2.16.840.1.113883.2.4.4.1.900.2' and code = '229')).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-15-1"/>
            <description value="Contains .dosageInstruction.sequence '1'. This assert checks only one child. Assert 2-15 checks if all children are present in the same parent"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').dosageInstruction.where(sequence = 1).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-15-2"/>
            <description value="Contains .dosageInstruction.text 'Gedurende 24 dagen, cyclus van 8 dagen: steeds gedurende 7 dagen, elke 4 uur n tablet, zo nodig n tablet extra, oraal'. This assert checks only one child. Assert 2-15 checks if all children are present in the same parent. This assert is set to warning because string comparisons can have many possible caveats"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').dosageInstruction.where(text.replaceMatches('[ .,_-]+', ' ') ~ 'Gedurende 24 dagen cyclus van 8 dagen: steeds gedurende 7 dagen elke 4 uur n tablet zo nodig n tablet extra oraal').exists()"/>
            <warningOnly value="true"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-15-3"/>
            <description value="Contains .dosageInstruction.additionalInstruction with .text 'Na 7 dagen n dag niet gebruiken'. This assert checks only one child. Assert 2-15 checks if all children are present in the same parent"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').dosageInstruction.where(additionalInstruction.where(text.replaceMatches('[ .,_-]+', ' ') ~ 'Na 7 dagen n dag niet gebruiken').exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-15-4"/>
            <description value="Contains .dosageInstruction.timing with .repeat with .boundsDuration with .value '21' and .unit 'dagen' and .system and .code 'd' and .period '4' and .periodUnit 'h'. This assert checks only one child. Assert 2-15 checks if all children are present in the same parent"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').dosageInstruction.where(timing.repeat.where(bounds.ofType(Duration).where(value = 21 and unit.replaceMatches('[ .,_-]+', ' ') ~ 'dagen' and system and code = 'd') and period = 4 and periodUnit = 'h').exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-15-5"/>
            <description value="Contains .dosageInstruction.route with .coding with .system 'urn:oid:2.16.840.1.113883.2.4.4.9' and .code '9' and .display. This assert checks only one child. Assert 2-15 checks if all children are present in the same parent"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').dosageInstruction.where(route.coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.4.9' and code = '9' and display).exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-15-6"/>
            <description value="Contains .dosageInstruction.doseQuantity with .value '600' and .unit and .system 'urn:oid:2.16.840.1.113883.2.4.4.1.900.2' and .code '229'. This assert checks only one child. Assert 2-15 checks if all children are present in the same parent"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').dosageInstruction.where(dose.ofType(Quantity).where(value = 600 and unit and system = 'urn:oid:2.16.840.1.113883.2.4.4.1.900.2' and code = '229').exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-16"/>
            <description value="Contains .dosageInstruction with .sequence '1' and .asNeededCodeableConcept with .coding with .system 'urn:oid:2.16.840.1.113883.2.4.4.5' and .code '1028' and .display and .doseRange with .high with .value '600' and .unit and .system 'urn:oid:2.16.840.1.113883.2.4.4.1.900.2' and .code '229' and .maxDosePerPeriod with .numerator with .value '600' and .unit and .system 'urn:oid:2.16.840.1.113883.2.4.4.1.900.2' and .code '229' and .denominator with .value '1' and .unit and .system 'http://unitsofmeasure.org' and .code 'd'. This assert checks if all children exist (if applicable with their specific values) and if they are present within one element. Following asserts check if individual children exist to help you debug if this assert fails"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').dosageInstruction.where(sequence = 1 and asNeeded.ofType(CodeableConcept).coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.4.5' and code = '1028' and display) and dose.ofType(Range).high.where(value = 600 and unit and system = 'urn:oid:2.16.840.1.113883.2.4.4.1.900.2' and code = '229') and maxDosePerPeriod.where(numerator.where(value = 600 and unit and system = 'urn:oid:2.16.840.1.113883.2.4.4.1.900.2' and code = '229') and denominator.where(value = 1 and unit and system = 'http://unitsofmeasure.org' and code = 'd'))).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-16-1"/>
            <description value="Contains .dosageInstruction.sequence '1'. This assert checks only one child. Assert 2-16 checks if all children are present in the same parent"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').dosageInstruction.where(sequence = 1).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-16-2"/>
            <description value="Contains .dosageInstruction.asNeededCodeableConcept with .coding with .system 'urn:oid:2.16.840.1.113883.2.4.4.5' and .code '1028' and .display. This assert checks only one child. Assert 2-16 checks if all children are present in the same parent"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').dosageInstruction.where(asNeeded.ofType(CodeableConcept).coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.4.5' and code = '1028' and display).exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-16-3"/>
            <description value="Contains .dosageInstruction.doseRange with .high with .value '600' and .unit and .system 'urn:oid:2.16.840.1.113883.2.4.4.1.900.2' and .code '229'. This assert checks only one child. Assert 2-16 checks if all children are present in the same parent"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').dosageInstruction.where(dose.ofType(Range).high.where(value = 600 and unit and system = 'urn:oid:2.16.840.1.113883.2.4.4.1.900.2' and code = '229').exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-16-4"/>
            <description value="Contains .dosageInstruction.maxDosePerPeriod with .numerator with .value '600' and .unit and .system 'urn:oid:2.16.840.1.113883.2.4.4.1.900.2' and .code '229' and .denominator with .value '1' and .unit and .system 'http://unitsofmeasure.org' and .code 'd'. This assert checks only one child. Assert 2-16 checks if all children are present in the same parent"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(MedicationDispense).where(id = '${zib-AdministrationAgreement-medmij-bgz-test-patA-admagr2-id}').dosageInstruction.where(maxDosePerPeriod.where(numerator.where(value = 600 and unit and system = 'urn:oid:2.16.840.1.113883.2.4.4.1.900.2' and code = '229') and denominator.where(value = 1 and unit and system = 'http://unitsofmeasure.org' and code = 'd')).exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
   </test>
   <test>
      <name value="Scenario 1.11.2 - AdministrationAgreement - Check Medication 1"/>
      <description value="Check if the previous operation results in a FHIR Medication that contains the values that are expected following Nictiz' materials (fixture .id: zib-Product-medmij-bgz-test-patA-product1)"/>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="Response Bundle contains exactly 1 Medication that contains .code.coding.code = '2182416'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Medication).where(code.where(coding.where(code = '2182416'))).count() = 1"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="Medication resource evaluated in the previous assert contains an .id"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Medication).where(code.where(coding.where(code = '2182416'))).id.exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-1"/>
            <description value="Contains .meta with .profile 'http://nictiz.nl/fhir/StructureDefinition/zib-Product'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Medication).where(id = '${zib-Product-medmij-bgz-test-patA-product1-id}').meta.profile.where($this = 'http://nictiz.nl/fhir/StructureDefinition/zib-Product').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-2"/>
            <description value="Contains .extension with url 'http://nictiz.nl/fhir/StructureDefinition/zib-Product-Description' with .valueString '2.5mg Apixaban filmomhulde tabletten'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Medication).where(id = '${zib-Product-medmij-bgz-test-patA-product1-id}').extension('http://nictiz.nl/fhir/StructureDefinition/zib-Product-Description').value.ofType(string).replaceMatches('[ .,_-]+', ' ') ~ '2 5mg Apixaban filmomhulde tabletten'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-3"/>
            <description value="Contains .code with .coding with .system 'urn:oid:2.16.840.1.113883.2.4.4.7' and .code '2182416' and .display and .text 'Apixaban 2.5mg'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Medication).where(id = '${zib-Product-medmij-bgz-test-patA-product1-id}').code.where(coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.4.7' and code = '2182416' and display) and text.replaceMatches('[ .,_-]+', ' ') ~ 'Apixaban 2 5mg').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-4"/>
            <description value="Contains .form with .coding with .system 'urn:oid:2.16.840.1.113883.2.4.4.11' and .code '230' and .display"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Medication).where(id = '${zib-Product-medmij-bgz-test-patA-product1-id}').form.coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.4.11' and code = '230' and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
   </test>
   <test>
      <name value="Scenario 1.11.2 - AdministrationAgreement - Check Medication 2"/>
      <description value="Check if the previous operation results in a FHIR Medication that contains the values that are expected following Nictiz' materials (fixture .id: zib-Product-medmij-bgz-test-patA-product2)"/>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="Response Bundle contains exactly 1 Medication that contains .code.coding.code = '2613093'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Medication).where(code.where(coding.where(code = '2613093'))).count() = 1"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="Medication resource evaluated in the previous assert contains an .id"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Medication).where(code.where(coding.where(code = '2613093'))).id.exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-1"/>
            <description value="Contains .meta with .profile 'http://nictiz.nl/fhir/StructureDefinition/zib-Product'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Medication).where(id = '${zib-Product-medmij-bgz-test-patA-product2-id}').meta.profile.where($this = 'http://nictiz.nl/fhir/StructureDefinition/zib-Product').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-2"/>
            <description value="Contains .extension with url 'http://nictiz.nl/fhir/StructureDefinition/zib-Product-Description' with .valueString '600mg ibuprofen filmomhulde tabletten'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Medication).where(id = '${zib-Product-medmij-bgz-test-patA-product2-id}').extension('http://nictiz.nl/fhir/StructureDefinition/zib-Product-Description').value.ofType(string).replaceMatches('[ .,_-]+', ' ') ~ '600mg ibuprofen filmomhulde tabletten'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-3"/>
            <description value="Contains .code with .coding with .system 'urn:oid:2.16.840.1.113883.2.4.4.7' and .code '2613093' and .display and .text 'Ibuprofen 600mg'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Medication).where(id = '${zib-Product-medmij-bgz-test-patA-product2-id}').code.where(coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.4.7' and code = '2613093' and display) and text.replaceMatches('[ .,_-]+', ' ') ~ 'Ibuprofen 600mg').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-4"/>
            <description value="Contains .form with .coding with .system 'urn:oid:2.16.840.1.113883.2.4.4.11' and .code '230' and .display"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Medication).where(id = '${zib-Product-medmij-bgz-test-patA-product2-id}').form.coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.4.11' and code = '230' and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
   </test>
</TestScript>
