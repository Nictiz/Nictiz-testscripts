<?xml version="1.0" encoding="UTF-8"?>
<TestScript xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript">
   <id value="phr-send-01-02-respiration"/>
   <meta>
      <profile value="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript"/>
   </meta>
   <url value="http://nictiz.nl/fhir/TestScript/phr-send-01-02-respiration"/>
   <version value="stu3-2.0-patchlevel 2023-09"/>
   <name value="SelfMeasurements - PHR Server - Scenario 1.2 - Send most recent respiration Observation resource"/>
   <status value="active"/>
   <publisher value="Nictiz"/>
   <contact>
      <name value="Nictiz"/>
      <telecom>
         <system value="email"/>
         <value value="kwalificatie@nictiz.nl"/>
         <use value="work"/>
      </telecom>
   </contact>
   <description value="Scenario 1.2 - Send most recent respiration Observation resource"/>
   <origin>
      <index value="1"/>
      <profile>
         <system value="http://terminology.hl7.org/CodeSystem/testscript-profile-origin-types"/>
         <code value="FHIR-Client"/>
      </profile>
   </origin>
   <destination>
      <index value="1"/>
      <profile>
         <system value="http://terminology.hl7.org/CodeSystem/testscript-profile-destination-types"/>
         <code value="FHIR-Server"/>
      </profile>
   </destination>
   <fixture id="scenario-1-2-bundle-fixture">
      <autocreate value="false"/>
      <autodelete value="false"/>
      <resource>
         <reference value="../_reference/bundles/send/selfmeasurements-send-scenario-1-2-respiration-bundle.xml"/>
      </resource>
   </fixture>
   <profile id="Bundle-profile">
      <reference value="http://hl7.org/fhir/StructureDefinition/Bundle"/>
   </profile>
   <variable>
      <name value="T"/>
      <defaultValue value="${CURRENTDATE}"/>
      <description value="Date that data and queries are expected to be relative to."/>
   </variable>
   <test id="scenario1-2-send-most-recent-respiration">
      <name value="Scenario 1.2"/>
      <description value="Send most recent respiration Observation resource"/>
      <action>
         <operation>
            <type>
               <system value="http://terminology.hl7.org/CodeSystem/testscript-operation-codes"/>
               <code value="batch"/>
            </type>
            <description value="Test PHR client to POST a Bundle of type batch."/>
            <destination value="1"/>
            <encodeRequestUrl value="true"/>
            <origin value="1"/>
            <requestHeader>
               <field value="Authorization"/>
               <value value="Bearer 805b20d7-09e7-4e03-a08e-7e8c19e9f9df"/>
            </requestHeader>
            <requestHeader>
               <field value="MedMij-Request-ID"/>
               <value value="${UUID}"/>
            </requestHeader>
            <requestId value="fixture-scenario1-2-send-most-recent-respiration"/>
            <sourceId value="scenario-1-2-bundle-fixture"/>
         </operation>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that request Bundle is of type batch."/>
            <direction value="request"/>
            <expression value="Bundle.type = 'batch'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that HTTP header Authorization contains the patient token Bearer 805b20d7-09e7-4e03-a08e-7e8c19e9f9df"/>
            <direction value="request"/>
            <headerField value="Authorization"/>
            <value value="Bearer 805b20d7-09e7-4e03-a08e-7e8c19e9f9df"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that query parameter 'patient=' was not present to avoid BSNs in the URL."/>
            <direction value="request"/>
            <operator value="notContains"/>
            <requestURL value="patient="/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that query parameter 'subject=' was not present to avoid BSNs in the URL."/>
            <direction value="request"/>
            <operator value="notContains"/>
            <requestURL value="subject="/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all resources that are updated contain a Resource.id and a fullUrl."/>
            <direction value="request"/>
            <expression value="Bundle.entry.where(request.method='PUT').all( $this.fullUrl.exists() and $this.resource.id.exists())"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all resources that are created don't contain a Resource.id. Warning only because it not forbidden, however, the resource does not need to have an id element. If an id is provided, the server SHALL ignore it."/>
            <direction value="request"/>
            <expression value="Bundle.entry.where(request.method='POST').all($this.resource.id.exists().not())"/>
            <warningOnly value="true"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all resources that are created don't have a RESTful fullUrl."/>
            <direction value="request"/>
            <expression value="Bundle.entry.where(request.method='POST').all( $this.fullUrl.startsWith('http://').not() and $this.fullUrl.startsWith('https://').not() )"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all resources that are created don't have a fullUrl or have a UUID or OID based fullUrl."/>
            <direction value="request"/>
            <expression value="Bundle.entry.where(request.method='POST').fullUrl.all( exists().not or matches('^urn:oid:[0-2](\\.(0|[1-9]\\d*))*$') or matches('^urn:uuid:[A-Fa-f\\d]{8}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{12}$') )"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all posted resources except Binary contain a meta.profile tag."/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.where(is(Binary).not()).where(meta.profile.empty()).empty()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the fullUrl does not disagree with the id in the resource, see http://hl7.org/fhir/stu3/bundle-definitions.html#Bundle.entry.fullUrl"/>
            <direction value="request"/>
            <expression value="Bundle.entry.where(fullUrl.exists() and resource.id.exists()).all($this.fullUrl.endsWith($this.resource.id))"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the fullUrl is an absolute URL, an uuid or an oid."/>
            <direction value="request"/>
            <expression value="Bundle.entry.fullUrl.all( startsWith('http://') or startsWith('https://') or matches('^urn:oid:[0-2](\\.(0|[1-9]\\d*))*$') or matches('^urn:uuid:[A-Fa-f\\d]{8}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{12}$') )"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the returned Bundle conforms to the base FHIR specification and the resources to the stated profiles in the meta.profile tag."/>
            <direction value="request"/>
            <validateProfileId value="Bundle-profile"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all coding elements contain both a .system and a .code."/>
            <direction value="request"/>
            <expression value="Bundle.descendants().where($this.is(coding)).all(system.exists() and code.exists())"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the OID of the zib valueset is not used for the system of a coding element."/>
            <direction value="request"/>
            <expression value="Bundle.descendants().where($this.is(coding)).system.startsWith('urn:oid:2.16.840.1.113883.2.4.3.11.60.40.2').not()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all CodeableConcept elements contain either a coding.display or a text value if no Coding exists or has an extension (e.g. a nullFlavor or data-absent-reason extension). For more information see https://informatiestandaarden.nictiz.nl/wiki/FHIR:V1.0_FHIR_IG_STU3Use_of_coded_concepts."/>
            <direction value="request"/>
            <expression value="Bundle.descendants().where($this.is(CodeableConcept)) .all(coding.display.exists() or text.exists() or extension.exists())"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all References have a display value, see https://informatiestandaarden.nictiz.nl/wiki/FHIR:V1.0_FHIR_IG_STU3#Use_of_the_reference_datatype."/>
            <direction value="request"/>
            <expression value="Bundle.descendants().where($this.is(Reference)).all(display.exists() or extension.where(url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason').exists() or extension.where(url = 'http://hl7.org/fhir/StructureDefinition/iso21090-nullFlavor').exists())"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all Identifiers have both a .system and a .value. In rare cases where a general category of identifiers can be used, .type can replace .system. Edge cases for both .system and .type to be unknown are not applicable to Nictiz. For more information, see https://www.hl7.org/fhir/stu3/datatypes.html#Identifier."/>
            <direction value="request"/>
            <expression value="Bundle.descendants().where($this.is(Identifier)).all((system.exists() or type.exists()) and value.exists())"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that Bundle does not use Burgerservicenummer (BSN) anywhere."/>
            <direction value="request"/>
            <expression value="Bundle.descendants().select(identifier.where(system = 'http://fhir.nl/fhir/NamingSystem/bsn').where(value.empty().not() and value.extension.exists().not())).count() = 0"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="Confirm that the operation was successful"/>
            <operator value="in"/>
            <responseCode value="200,201"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Make sure the test server (WildFHIR) handles each resource in the batch Bundle correctly"/>
            <direction value="response"/>
            <expression value="Bundle.response.status.all($this.startsWith('200') or $this.startsWith('201'))"/>
            <warningOnly value="false"/>
         </assert>
      </action>
   </test>
   <test>
      <name value="Scenario 1.2 - Check Observation 1"/>
      <description value="Check if the previous operation results in a FHIR Observation that contains the values that are expected following Nictiz' materials (fixture .id: selfmeasurements-send-Respiration2)"/>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="Request Bundle contains exactly 1 Observation that contains a component with code = '9279-1' and valueQuantity.value = '24'"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).count() = 1"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-1"/>
            <description value="Contains .meta with .profile 'http://nictiz.nl/fhir/StructureDefinition/zib-Respiration'"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).meta.profile.where($this = 'http://nictiz.nl/fhir/StructureDefinition/zib-Respiration').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-2"/>
            <description value="Contains .extension with url 'http://nictiz.nl/fhir/StructureDefinition/zib-Respiration-AdministeredOxygen' with .extension with url 'extraOxygenAdministration' with .valueBoolean 'true' and .extension with url 'fiO2' with .valueQuantity with .value '0.4' and .unit and .system 'http://unitsofmeasure.org'. This assert checks if all children exist (if applicable with their specific values) and if they are present within one element. Following asserts check if individual children exist to help you debug if this assert fails"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).extension('http://nictiz.nl/fhir/StructureDefinition/zib-Respiration-AdministeredOxygen').where(extension('extraOxygenAdministration').value.ofType(boolean) = true and extension('fiO2').value.ofType(Quantity).where(value = 0.4 and unit and system = 'http://unitsofmeasure.org')).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-2-1"/>
            <description value="Contains .extension('http://nictiz.nl/fhir/StructureDefinition/zib-Respiration-AdministeredOxygen').extension with url 'extraOxygenAdministration' with .valueBoolean 'true'. This assert checks only one child. Assert 1-2 checks if all children are present in the same parent"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).extension('http://nictiz.nl/fhir/StructureDefinition/zib-Respiration-AdministeredOxygen').extension('extraOxygenAdministration').value.ofType(boolean) = true"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-2-2"/>
            <description value="Contains .extension('http://nictiz.nl/fhir/StructureDefinition/zib-Respiration-AdministeredOxygen').extension with url 'fiO2' with .valueQuantity with .value '0.4' and .unit and .system 'http://unitsofmeasure.org'. This assert checks only one child. Assert 1-2 checks if all children are present in the same parent"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).extension('http://nictiz.nl/fhir/StructureDefinition/zib-Respiration-AdministeredOxygen').extension('fiO2').value.ofType(Quantity).where(value = 0.4 and unit and system = 'http://unitsofmeasure.org').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-3"/>
            <description value="Contains .identifier with .system and .value"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).identifier.where(system and value).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-4"/>
            <description value="Contains .status 'final'"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).status = 'final'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-5"/>
            <description value="Contains .category with .coding with .system 'http://hl7.org/fhir/observation-category' and .code 'vital-signs' and .display"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).category.where(coding.where(system = 'http://hl7.org/fhir/observation-category' and code = 'vital-signs' and display)).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-6"/>
            <description value="Contains .code with .coding with .system 'http://snomed.info/sct' and .code '422834003' and .display"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).code.coding.where(system = 'http://snomed.info/sct' and code = '422834003' and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-7"/>
            <description value="Contains .subject with either .reference or .identifier and .display"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).subject.where((reference or identifier) and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-8"/>
            <description value="Contains .effectiveDateTime"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).effective.ofType(dateTime).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-9"/>
            <description value="Contains .performer with either .reference or .identifier and .display"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).performer.where((reference or identifier) and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-10"/>
            <description value="Contains .comment 'Na halve marathon'. This assert is set to warning because string comparisons can have many possible caveats"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).comment.replaceMatches('[ .,_-]+', ' ') ~ 'Na halve marathon'"/>
            <warningOnly value="true"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-11"/>
            <description value="Contains .component with .code with .coding with .system 'http://loinc.org' and .code '9279-1' and .display and .valueQuantity with .value '24' and .unit and .system 'http://unitsofmeasure.org' and .code matching regex '^\\{.+\\}/min$'. This assert checks if all children exist (if applicable with their specific values) and if they are present within one element. Following asserts check if individual children exist to help you debug if this assert fails"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).component.where(code.coding.where(system = 'http://loinc.org' and code = '9279-1' and display) and value.ofType(Quantity).where(value = 24 and unit and system = 'http://unitsofmeasure.org' and code.matches('^\\{.+\\}/min$'))).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-11-1"/>
            <description value="Contains .component.code with .coding with .system 'http://loinc.org' and .code '9279-1' and .display. This assert checks only one child. Assert 1-11 checks if all children are present in the same parent"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).component.where(code.coding.where(system = 'http://loinc.org' and code = '9279-1' and display).exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-11-2"/>
            <description value="Contains .component.valueQuantity with .value '24' and .unit and .system 'http://unitsofmeasure.org' and .code matching regex '^\\{.+\\}/min$'. This assert checks only one child. Assert 1-11 checks if all children are present in the same parent"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).component.where(value.ofType(Quantity).where(value = 24 and unit and system = 'http://unitsofmeasure.org' and code.matches('^\\{.+\\}/min$')).exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-12"/>
            <description value="Contains .component with .code with .coding with .system 'http://snomed.info/sct' and .code '48064009' and .display and .valueCodeableConcept with .coding with .system 'http://snomed.info/sct' and .code '5467003' and .display. This assert checks if all children exist (if applicable with their specific values) and if they are present within one element. Following asserts check if individual children exist to help you debug if this assert fails"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).component.where(code.coding.where(system = 'http://snomed.info/sct' and code = '48064009' and display) and value.ofType(CodeableConcept).coding.where(system = 'http://snomed.info/sct' and code = '5467003' and display)).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-12-1"/>
            <description value="Contains .component.code with .coding with .system 'http://snomed.info/sct' and .code '48064009' and .display. This assert checks only one child. Assert 1-12 checks if all children are present in the same parent"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).component.where(code.coding.where(system = 'http://snomed.info/sct' and code = '48064009' and display).exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-12-2"/>
            <description value="Contains .component.valueCodeableConcept with .coding with .system 'http://snomed.info/sct' and .code '5467003' and .display. This assert checks only one child. Assert 1-12 checks if all children are present in the same parent"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).component.where(value.ofType(CodeableConcept).coding.where(system = 'http://snomed.info/sct' and code = '5467003' and display).exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-13"/>
            <description value="Contains .component with .code with .coding with .system 'http://snomed.info/sct' and .code '271626009' and .display and .valueCodeableConcept with .coding with .system 'http://snomed.info/sct' and .code '301284009' and .display. This assert checks if all children exist (if applicable with their specific values) and if they are present within one element. Following asserts check if individual children exist to help you debug if this assert fails"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).component.where(code.coding.where(system = 'http://snomed.info/sct' and code = '271626009' and display) and value.ofType(CodeableConcept).coding.where(system = 'http://snomed.info/sct' and code = '301284009' and display)).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-13-1"/>
            <description value="Contains .component.code with .coding with .system 'http://snomed.info/sct' and .code '271626009' and .display. This assert checks only one child. Assert 1-13 checks if all children are present in the same parent"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).component.where(code.coding.where(system = 'http://snomed.info/sct' and code = '271626009' and display).exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="1-13-2"/>
            <description value="Contains .component.valueCodeableConcept with .coding with .system 'http://snomed.info/sct' and .code '301284009' and .display. This assert checks only one child. Assert 1-13 checks if all children are present in the same parent"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 24)).component.where(value.ofType(CodeableConcept).coding.where(system = 'http://snomed.info/sct' and code = '301284009' and display).exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
   </test>
   <test>
      <name value="Scenario 1.2 - Check Observation 2"/>
      <description value="Check if the previous operation results in a FHIR Observation that contains the values that are expected following Nictiz' materials (fixture .id: selfmeasurements-send-Respiration3)"/>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="Request Bundle contains exactly 1 Observation that contains a component with code = '9279-1' and valueQuantity.value = '14'"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).count() = 1"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-1"/>
            <description value="Contains .meta with .profile 'http://nictiz.nl/fhir/StructureDefinition/zib-Respiration'"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).meta.profile.where($this = 'http://nictiz.nl/fhir/StructureDefinition/zib-Respiration').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-2"/>
            <description value="Contains .identifier with .system and .value"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).identifier.where(system and value).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-3"/>
            <description value="Contains .status 'final'"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).status = 'final'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-4"/>
            <description value="Contains .category with .coding with .system 'http://hl7.org/fhir/observation-category' and .code 'vital-signs' and .display"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).category.where(coding.where(system = 'http://hl7.org/fhir/observation-category' and code = 'vital-signs' and display)).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-5"/>
            <description value="Contains .code with .coding with .system 'http://snomed.info/sct' and .code '422834003' and .display"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).code.coding.where(system = 'http://snomed.info/sct' and code = '422834003' and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-6"/>
            <description value="Contains .subject with either .reference or .identifier and .display"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).subject.where((reference or identifier) and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-7"/>
            <description value="Contains .effectiveDateTime"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).effective.ofType(dateTime).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-8"/>
            <description value="Contains .performer with either .reference or .identifier and .display"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).performer.where((reference or identifier) and display).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-9"/>
            <description value="Contains .component with .code with .coding with .system 'http://loinc.org' and .code '9279-1' and .display and .valueQuantity with .value '14' and .unit and .system 'http://unitsofmeasure.org' and .code matching regex '^\\{.+\\}/min$'. This assert checks if all children exist (if applicable with their specific values) and if they are present within one element. Following asserts check if individual children exist to help you debug if this assert fails"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).component.where(code.coding.where(system = 'http://loinc.org' and code = '9279-1' and display) and value.ofType(Quantity).where(value = 14 and unit and system = 'http://unitsofmeasure.org' and code.matches('^\\{.+\\}/min$'))).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-9-1"/>
            <description value="Contains .component.code with .coding with .system 'http://loinc.org' and .code '9279-1' and .display. This assert checks only one child. Assert 2-9 checks if all children are present in the same parent"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).component.where(code.coding.where(system = 'http://loinc.org' and code = '9279-1' and display).exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-9-2"/>
            <description value="Contains .component.valueQuantity with .value '14' and .unit and .system 'http://unitsofmeasure.org' and .code matching regex '^\\{.+\\}/min$'. This assert checks only one child. Assert 2-9 checks if all children are present in the same parent"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).component.where(value.ofType(Quantity).where(value = 14 and unit and system = 'http://unitsofmeasure.org' and code.matches('^\\{.+\\}/min$')).exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-10"/>
            <description value="Contains .component with .code with .coding with .system 'http://snomed.info/sct' and .code '48064009' and .display and .valueCodeableConcept with .coding with .system 'http://snomed.info/sct' and .code '5467003' and .display. This assert checks if all children exist (if applicable with their specific values) and if they are present within one element. Following asserts check if individual children exist to help you debug if this assert fails"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).component.where(code.coding.where(system = 'http://snomed.info/sct' and code = '48064009' and display) and value.ofType(CodeableConcept).coding.where(system = 'http://snomed.info/sct' and code = '5467003' and display)).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-10-1"/>
            <description value="Contains .component.code with .coding with .system 'http://snomed.info/sct' and .code '48064009' and .display. This assert checks only one child. Assert 2-10 checks if all children are present in the same parent"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).component.where(code.coding.where(system = 'http://snomed.info/sct' and code = '48064009' and display).exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-10-2"/>
            <description value="Contains .component.valueCodeableConcept with .coding with .system 'http://snomed.info/sct' and .code '5467003' and .display. This assert checks only one child. Assert 2-10 checks if all children are present in the same parent"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).component.where(value.ofType(CodeableConcept).coding.where(system = 'http://snomed.info/sct' and code = '5467003' and display).exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-11"/>
            <description value="Contains .component with .code with .coding with .system 'http://snomed.info/sct' and .code '271626009' and .display and .valueCodeableConcept with .coding with .system 'http://snomed.info/sct' and .code '301284009' and .display. This assert checks if all children exist (if applicable with their specific values) and if they are present within one element. Following asserts check if individual children exist to help you debug if this assert fails"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).component.where(code.coding.where(system = 'http://snomed.info/sct' and code = '271626009' and display) and value.ofType(CodeableConcept).coding.where(system = 'http://snomed.info/sct' and code = '301284009' and display)).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-11-1"/>
            <description value="Contains .component.code with .coding with .system 'http://snomed.info/sct' and .code '271626009' and .display. This assert checks only one child. Assert 2-11 checks if all children are present in the same parent"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).component.where(code.coding.where(system = 'http://snomed.info/sct' and code = '271626009' and display).exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <label value="2-11-2"/>
            <description value="Contains .component.valueCodeableConcept with .coding with .system 'http://snomed.info/sct' and .code '301284009' and .display. This assert checks only one child. Assert 2-11 checks if all children are present in the same parent"/>
            <direction value="request"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(component.where(code.coding.where(code = '9279-1') and value.ofType(Quantity).value = 14)).component.where(value.ofType(CodeableConcept).coding.where(system = 'http://snomed.info/sct' and code = '301284009' and display).exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
   </test>
</TestScript>
