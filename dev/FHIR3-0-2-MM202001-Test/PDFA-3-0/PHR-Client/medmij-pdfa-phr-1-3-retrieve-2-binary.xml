<?xml version="1.0" encoding="UTF-8"?>
<TestScript xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript">
   <id value="phr-1-3-retrieve-2-binary"/>
   <meta>
      <profile value="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript"/>
   </meta>
   <url value="http://nictiz.nl/fhir/TestScript/phr-1-3-retrieve-2-binary"/>
   <version value="stu3-2.0"/>
   <name value="PDFA - PHR Client - Scenario 1.3 - Retrieve 2 times 1 Binary resources"/>
   <status value="active"/>
   <date value="2021-02-11"/>
   <publisher value="Nictiz"/>
   <contact>
      <name value="Nictiz"/>
      <telecom>
         <system value="email"/>
         <value value="kwalificatie@nictiz.nl"/>
         <use value="work"/>
      </telecom>
   </contact>
   <description value="Scenario 1.3 - Retrieve Binary resources of XXX-Baltus."/>
   <origin>
      <index value="1"/>
      <profile>
         <system value="http://hl7.org/fhir/testscript-profile-origin-types"/>
         <code value="FHIR-Client"/>
      </profile>
   </origin>
   <destination>
      <index value="1"/>
      <profile>
         <system value="http://hl7.org/fhir/testscript-profile-destination-types"/>
         <code value="FHIR-Server"/>
      </profile>
   </destination>
   <fixture id="patient-token-fixture">
      <resource>
         <reference value="../_reference/pdfa-nl-core-patient-XXX-Baltus-token.xml"/>
      </resource>
   </fixture>
   <fixture id="binary1-fixture">
      <resource>
         <reference value="../_reference/resources/medmij-pdfa-Binary-kwalificatie1.xml"/>
      </resource>
   </fixture>
   <fixture id="binary2-fixture">
      <resource>
         <reference value="../_reference/resources/medmij-pdfa-Binary-kwalificatie2.xml"/>
      </resource>
   </fixture>
   <variable>
      <name value="patient-token-id"/>
      <expression value="Patient.id"/>
      <sourceId value="patient-token-fixture"/>
   </variable>
   <variable>
      <name value="binary1-id"/>
      <expression value="Binary.id"/>
      <sourceId value="binary1-fixture"/>
   </variable>
   <variable>
      <name value="binary2-id"/>
      <expression value="Binary.id"/>
      <sourceId value="binary2-fixture"/>
   </variable>
   <test id="scenario1-3-retrieve-binary-1">
      <name value="Scenario 1.3- Binary 1"/>
      <description value="Read Binary resource"/>
      <action>
         <operation>
            <type>
               <system value="http://hl7.org/fhir/testscript-operation-codes"/>
               <code value="search"/>
            </type>
            <resource value="Binary"/>
            <description value="Test PHR client to retrieve Binary resources."/>
            <destination value="1"/>
            <origin value="1"/>
            <params value="/${binary1-id}"/>
            <requestHeader>
               <field value="Authorization"/>
               <value value="${patient-token-id}"/>
            </requestHeader>
         </operation>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that HTTP header Authorization contains the patient token ${patient-token-id}"/>
            <direction value="request"/>
            <headerField value="Authorization"/>
            <value value="${patient-token-id}"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that query parameter 'patient=' was not present to avoid BSNs in the URL."/>
            <direction value="request"/>
            <operator value="notContains"/>
            <requestURL value="patient="/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that query parameter 'subject=' was not present to avoid BSNs in the URL."/>
            <direction value="request"/>
            <operator value="notContains"/>
            <requestURL value="subject="/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="Confirm that the operation was succesful"/>
            <operator value="in"/>
            <responseCode value="200,201"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that a Binary is returned."/>
            <direction value="response"/>
            <expression value="Binary.count() = 1"/>
         </assert>
      </action>
   </test>
   <test id="scenario1-3-read-binary-2">
      <name value="Scenario 1.3 - Binary 2"/>
      <description value="Read Binary resource"/>
      <action>
         <operation>
            <type>
               <system value="http://hl7.org/fhir/testscript-operation-codes"/>
               <code value="search"/>
            </type>
            <resource value="Binary"/>
            <description value="Test PHR client to retrieve Binary resources."/>
            <destination value="1"/>
            <origin value="1"/>
            <params value="/${binary2-id}"/>
            <requestHeader>
               <field value="Authorization"/>
               <value value="${patient-token-id}"/>
            </requestHeader>
         </operation>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that HTTP header Authorization contains the patient token ${patient-token-id}"/>
            <direction value="request"/>
            <headerField value="Authorization"/>
            <value value="${patient-token-id}"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that query parameter 'patient=' was not present to avoid BSNs in the URL."/>
            <direction value="request"/>
            <operator value="notContains"/>
            <requestURL value="patient="/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that query parameter 'subject=' was not present to avoid BSNs in the URL."/>
            <direction value="request"/>
            <operator value="notContains"/>
            <requestURL value="subject="/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="Confirm that the operation was succesful"/>
            <operator value="in"/>
            <responseCode value="200,201"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that a Binary is returned."/>
            <direction value="response"/>
            <expression value="Binary.count() = 1"/>
         </assert>
      </action>
   </test>
</TestScript>
