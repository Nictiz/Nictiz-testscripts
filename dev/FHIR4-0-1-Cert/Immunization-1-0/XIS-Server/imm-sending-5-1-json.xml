<?xml version="1.0" encoding="UTF-8"?>
<TestScript xmlns="http://hl7.org/fhir" xmlns:nts="http://nictiz.nl/xsl/testscript">
   <id value="imm-sending-2-1-json"/>
   <meta>
      <profile value="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript"/>
   </meta>
   <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-rule">
      <extension url="ruleId">
         <valueId value="assert_response_queryParamsInSelfLink"/>
      </extension>
      <extension url="path">
         <valueString value="../_reference/rules/assert_response_queryParamsInSelfLink.groovy"/>
      </extension>
   </extension>
   <url value="http://nictiz.nl/fhir/TestScript/imm-sending-2-1-json"/>
   <version value="r4-1.0.0-patchlevel 2022-11"/>
   <name value="Immunization - XIS Server - Scenario 2.1 - Serve Immunization resources of 'van der Voorden-der Teeuwen' - JSON Format"/>
   <status value="active"/>
   <publisher value="Nictiz"/>
   <contact>
      <name value="Nictiz"/>
      <telecom>
         <system value="email"/>
         <value value="kwalificatie@nictiz.nl"/>
         <use value="work"/>
      </telecom>
   </contact>
   <description value="Scenario 2.1 - Serve Immunization resources of 'van der Voorden-der Teeuwen'"/>
   <origin>
      <index value="1"/>
      <profile>
         <system value="http://terminology.hl7.org/CodeSystem/testscript-profile-origin-types"/>
         <code value="FHIR-Client"/>
      </profile>
   </origin>
   <destination>
      <index value="1"/>
      <profile>
         <system value="http://terminology.hl7.org/CodeSystem/testscript-profile-destination-types"/>
         <code value="FHIR-Server"/>
      </profile>
   </destination>
   <profile id="Bundle-profile">
      <reference value="http://hl7.org/fhir/StructureDefinition/Bundle"/>
   </profile>
   <variable>
      <name value="patient-token-id"/>
      <defaultValue value="Bearer 7066cb09-a06b-45c0-84ac-e14368964bb1"/>
      <description value="OAuth Token for current patient"/>
   </variable>
   <variable>
      <name value="immunization-identifier-01"/>
      <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(vaccinCode.coding.code = '74691').where(occurence = @2007-04-12T00:00:00+02:00).identifier.value"/>
      <sourceId value="immunization-search-response"/>
   </variable>
   <variable>
      <name value="immunization-identifier-system-01"/>
      <expression value="Bundle.entry.where(resource.is(Immunization)).where(vaccinCode.coding.code = '74691').where(occurence = @2007-04-12T00:00:00+02:00).resource.identifier.system"/>
      <sourceId value="immunization-search-response"/>
   </variable>
   <variable>
      <name value="immunization-identifier-02"/>
      <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(vaccinCode.coding.code = '91804').where(occurence = @2007-04-12T00:00:00+02:00).identifier.value"/>
      <sourceId value="immunization-search-response"/>
   </variable>
   <variable>
      <name value="immunization-identifier-system-02"/>
      <expression value="Bundle.entry.where(resource.is(Immunization)).where(vaccinCode.coding.code = '91804').where(occurence = @2007-04-12T00:00:00+02:00).resource.identifier.system"/>
      <sourceId value="immunization-search-response"/>
   </variable>
   <variable>
      <name value="immunization-identifier-03"/>
      <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(vaccinCode.coding.code = '2925508').where(occurence = @2021-02-19T14:52:00+01:00).identifier.value"/>
      <sourceId value="immunization-search-response"/>
   </variable>
   <variable>
      <name value="immunization-identifier-system-03"/>
      <expression value="Bundle.entry.where(resource.is(Immunization)).where(vaccinCode.coding.code = '2925508').where(occurence = @2021-02-19T14:52:00+01:00).resource.identifier.system"/>
      <sourceId value="immunization-search-response"/>
   </variable>
   <variable>
      <name value="immunization-identifier-04"/>
      <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(vaccinCode.coding.code = '2924528').where(occurence = @2021-12-30T00:00:00+01:00).identifier.value"/>
      <sourceId value="immunization-search-response"/>
   </variable>
   <variable>
      <name value="immunization-identifier-system-04"/>
      <expression value="Bundle.entry.where(resource.is(Immunization)).where(vaccinCode.coding.code = '2924528').where(occurence = @2021-12-30T00:00:00+01:00).resource.identifier.system"/>
      <sourceId value="immunization-search-response"/>
   </variable>
   <variable>
      <name value="pharmaceuticalProduct-url-1"/>
      <!-- Pick the absolute url as is or create an absolute url when a relative url is given by combining the base url given in the Bundle self link with the relative reference.-->
      <expression value="iif(Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference.startsWith('Medication/'),             Bundle.link.where(relation='self').url.replaceMatches('Immunization[/?].*$','') + Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference,             Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference)"/>
      <sourceId value="immunization-search-response"/>
   </variable>
   <variable>
      <name value="pharmaceuticalProduct-url-2"/>
      <!-- Pick the absolute url as is or create an absolute url when a relative url is given by combining the base url given in the Bundle self link with the relative reference.-->
      <expression value="iif(Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference.startsWith('Medication/'),             Bundle.link.where(relation='self').url.replaceMatches('Immunization[/?].*$','') + Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference,             Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference)"/>
      <sourceId value="immunization-search-response"/>
   </variable>
   <variable>
      <name value="pharmaceuticalProduct-url-3"/>
      <!-- Pick the absolute url as is or create an absolute url when a relative url is given by combining the base url given in the Bundle self link with the relative reference.-->
      <expression value="iif(Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference.startsWith('Medication/'),             Bundle.link.where(relation='self').url.replaceMatches('Immunization[/?].*$','') + Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference,             Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference)"/>
      <sourceId value="immunization-search-response"/>
   </variable>
   <variable>
      <name value="pharmaceuticalProduct-url-4"/>
      <!-- Pick the absolute url as is or create an absolute url when a relative url is given by combining the base url given in the Bundle self link with the relative reference.-->
      <expression value="iif(Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference.startsWith('Medication/'),             Bundle.link.where(relation='self').url.replaceMatches('Immunization[/?].*$','') + Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference,             Bundle.entry.where(resource.is(Immunization)).resource.extension.where(url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct').value.reference)"/>
      <sourceId value="immunization-search-response"/>
   </variable>
   <test>
      <name value="Scenario 2.1 - Get Immunizations"/>
      <description value="Serve Immunization resource including the patient"/>
      <action>
         <operation>
            <type>
               <system value="http://terminology.hl7.org/CodeSystem/testscript-operation-codes"/>
               <code value="search"/>
            </type>
            <resource value="Immunization"/>
            <description value="Test XIS server to serve Immunization resources."/>
            <accept value="json"/>
            <destination value="1"/>
            <encodeRequestUrl value="true"/>
            <origin value="1"/>
            <params value="?_include=Immunization:patient&amp;_include=Immunization:performer"/>
            <requestHeader>
               <field value="Authorization"/>
               <value value="${patient-token-id}"/>
            </requestHeader>
            <requestHeader>
               <field value="MedMij-Request-ID"/>
               <value value="${UUID}"/>
            </requestHeader>
            <responseId value="immunization-search-response"/>
         </operation>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="true"/>
            </extension>
            <description value="Confirm that the operation was successful"/>
            <operator value="in"/>
            <responseCode value="200,201"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the returned resource type is Bundle."/>
            <direction value="response"/>
            <resource value="Bundle"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the returned Bundle type is searchset."/>
            <direction value="response"/>
            <expression value="Bundle.type"/>
            <operator value="equals"/>
            <value value="searchset"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all returned resources contain an Resource.id except when temporary ids are used in the Bundle. The only time that a resource does not have an id is when it is being submitted to the server using a create operation: https://www.hl7.org/fhir/STU3/resource-definitions.html#Resource.id "/>
            <direction value="response"/>
            <expression value="Bundle.entry.all( $this.fullUrl.matches('^urn:oid:[0-2](\\.(0|[1-9]\\d*))*$') or $this.fullUrl.matches('^urn:uuid:[A-Fa-f\\d]{8}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{12}$') or $this.resource.id.exists())"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all returned resources except OperationOutcome and Binary contain a meta.profile tag."/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.where(is(OperationOutcome).not()).where(is(Binary).not()).where(meta.profile.empty()).empty()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the fullUrl does not disagree with the id in the resource, see http://hl7.org/fhir/stu3/bundle-definitions.html#Bundle.entry.fullUrl"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(fullUrl.exists() and resource.id.exists()).all($this.fullUrl.endsWith($this.resource.id))"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the fullUrl is an absolute URL, an uuid or an oid."/>
            <direction value="response"/>
            <expression value="Bundle.entry.fullUrl.all( startsWith('http://') or startsWith('https://') or matches('^urn:oid:[0-2](\\.(0|[1-9]\\d*))*$') or matches('^urn:uuid:[A-Fa-f\\d]{8}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{12}$') )"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that literal References (Reference.reference) are an absolute URL, a relative URL or an internal fragment reference (contained), see: http://hl7.org/fhir/stu3/references.html#literal."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().where($this as Reference).reference.all( startsWith('http://') or startsWith('https://') or startsWith('#') or matches('^urn:oid:[0-2](\\.(0|[1-9]\\d*))*$') or matches('^urn:uuid:[A-Fa-f\\d]{8}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{12}$') or (startsWith('urn:').not() and startsWith('#').not() and matches('^[A-Za-z]{3,}/[^/]+$')) )"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the returned Bundle conforms to the base FHIR specification and the resources to the stated profiles in the meta.profile tag."/>
            <direction value="response"/>
            <validateProfileId value="Bundle-profile"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all coding elements contain both a .system and a .code."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().where($this.is(coding)).all(system.exists() and code.exists())"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the OID of the zib valueset is not used for the system of a coding element."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().where($this.is(coding)).system.startsWith('urn:oid:2.16.840.1.113883.2.4.3.11.60.40.2').not()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all CodeableConcept elements contain either a coding.display or a text value if no Coding exists or has an extension (e.g. a nullFlavor or data-absent-reason extension). For more information see https://informatiestandaarden.nictiz.nl/wiki/FHIR:V1.0_FHIR_IG_STU3Use_of_coded_concepts."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().where($this.is(CodeableConcept)) .all(coding.display.exists() or text.exists() or extension.exists())"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all References have a display value, see https://informatiestandaarden.nictiz.nl/wiki/FHIR:V1.0_FHIR_IG_STU3#Use_of_the_reference_datatype."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().where($this.is(Reference)).all(display.exists() or extension.where(url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason').exists() or extension.where(url = 'http://hl7.org/fhir/StructureDefinition/iso21090-nullFlavor').exists())"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that all Identifiers have both a .system and a .value. In rare cases where a general category of identifiers can be used, .type can replace .system. Edge cases for both .system and .type to be unknown are not applicable to Nictiz. For more information, see https://www.hl7.org/fhir/stu3/datatypes.html#Identifier."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().where($this.is(Identifier)).all((system.exists() or type.exists()) and value.exists())"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that Bundle does not use Burgerservicenummer (BSN) anywhere."/>
            <direction value="response"/>
            <expression value="Bundle.descendants().select(identifier.where(system = 'http://fhir.nl/fhir/NamingSystem/bsn').where(value.empty().not() and value.extension.exists().not())).count() = 0"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the returned Bundle total value matches or is less than the number of entries in the Bundle. The included resources should not be counted as entries in the Bundle.total."/>
            <direction value="response"/>
            <expression value="Bundle.total.toInteger() &lt;= Bundle.entry.where(search.empty() or search.mode = 'match').count()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the returned Bundle contains a self link."/>
            <direction value="response"/>
            <expression value="Bundle.link.where(relation = 'self' and url.exists()).exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that Bundle does not use Burgerservicenummer (BSN) in the self link."/>
            <direction value="response"/>
            <expression value="Bundle.link.url.contains('http://fhir.nl/fhir/NamingSystem/bsn') = false"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-rule">
               <extension url="ruleId">
                  <valueId value="assert_response_queryParamsInSelfLink"/>
               </extension>
            </extension>
            <warningOnly value="true"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the response Bundle contains 4 Immunization resource(s). "/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).count() = 4"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the response Bundle contains 1 Patient resource(s). "/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Patient)).count() = 1"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <!-- Test Immunization resource 1 -->
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm the Immunization resource contains an identifier"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.as(Immunization).identifier.exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm the Immunization resource contains an identifier value"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.as(Immunization).identifier.value.exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm the Immunization resource contains an identifier system"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.as(Immunization).identifier.system.exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the response Bundle contains a unique identifier with the value '${immunization-identifier-01}' and system '${immunization-identifier-system-01}'."/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').count() = 1"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if the pharmaceutical extension 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct' exists"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').extension.url = 'http://nictiz.nl/fhir/StructureDefinition/ext-Vaccination.PharmaceuticalProduct'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if the pharmaceutical reference of type 'Medication' exists"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').extension.value.where(type = 'Medication').reference.exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the Immunization resource with the identifier ${immunization-identifier-01} has the status 'completed'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').status= 'completed'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if vaccinecode code corresponds to test material"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').vaccineCode.coding.code = '74691'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if vaccinecode system corresponds to test material"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').vaccineCode.coding.system = 'urn:oid:2.16.840.1.113883.2.4.4.10'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the Immunization resource contains a reference of the type 'Patient'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').patient.where(type = 'Patient').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm that the Immunization resource contains the correct occurence'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').occurrence = @2007-04-12T00:00:00+02:00"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <!-- site -->
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if the site laterality extension 'http://nictiz.nl/fhir/StructureDefinition/ext-AnatomicalLocation.Laterality' exists."/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').site.extension.url = 'http://nictiz.nl/fhir/StructureDefinition/ext-AnatomicalLocation.Laterality'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if the correct lateralitycode for site exists"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').site.extension.value.coding.where(system = 'http://snomed.info/sct').code = '7771000'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if the correct code for site exists"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').site.coding.where(system = 'http://snomed.info/sct').code = '40983000'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <!-- route -->
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if the correct code for route exists"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').route.coding.where(system = 'urn:oid:2.16.840.1.113883.2.4.4.9').code = '2'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <!-- dose -->
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if the doseQuantity value is '0.5'."/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').doseQuantity.value = '0.5'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if the doseQuantity unit is in 'ml'."/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').doseQuantity.unit = 'ml'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if the doseQuantity code is in 'ml'."/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').doseQuantity.code = 'ml'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test the doseQuantity system is 'http://unitsofmeasure.org'."/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').doseQuantity.system = 'http://unitsofmeasure.org'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <!-- performer -->
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if performer exists"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').performer.function.coding.code = 'AP'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if performer codessytem exists"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').performer.function.coding.system = 'http://terminology.hl7.org/CodeSystem/v2-0443'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if performer reference of type 'PractitionerRole' exists"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').performer.actor.where(type = 'PractitionerRole').reference.exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <!-- note -->
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Confirm the Immunization resource contains the right note."/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.as(Immunization).where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').note.text='rechterbovenarm in gips'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <!-- reasonCode -->
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if the correct code for route exists"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').reasonCode.coding.where(system = 'http://snomed.info/sct').where(code = '159741000146107').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if the correct code for route exists"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').reasonCode.coding.where(system = 'http://snomed.info/sct').where(code = '159731000146104').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if the correct code for route exists"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').reasonCode.coding.where(system = 'http://snomed.info/sct').where(code = '404904002').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if the correct code for route exists"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').reasonCode.coding.where(system = 'http://snomed.info/sct').where(code = '19829001').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <!-- protocolApplied -->
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if the correct code for protocolApplied exists"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').protocolApplied.targetDisease.coding.where(system = 'http://snomed.info/sct').where(code = '6142004').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if the dosenumber is 'n/a' for protocolApplied."/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').protocolApplied.where(targetDisease.coding.system = 'http://snomed.info/sct').where(targetDisease.coding.code = '6142004').doseNumber = 'n/a'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if the correct code for protocolApplied exists"/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').protocolApplied.targetDisease.coding.where(system = 'http://snomed.info/sct').where(code = '128241005').exists()"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <action>
         <assert>
            <extension url="http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-stopTestOnFail">
               <valueBoolean value="false"/>
            </extension>
            <description value="Test if the dosenumber is 'n/a' for protocolApplied."/>
            <direction value="response"/>
            <expression value="Bundle.entry.where(resource.is(Immunization)).resource.where(identifier.value = '${immunization-identifier-01}').where(identifier.system = '${immunization-identifier-system-01}').protocolApplied.where(targetDisease.coding.system = 'http://snomed.info/sct').where(targetDisease.coding.code = '128241005').doseNumber = 'n/a'"/>
            <warningOnly value="false"/>
         </assert>
      </action>
      <!-- Test Immunization resource 2 -->
      <!-- Test Immunization resource 3 -->
      <!-- Test Immunization resource 4 -->
      <!-- Patient -->
      <!--        <nts:include value="assert.response.numResources" scope="common" resource="Patient" count="1"/>
        <nts:include value="assert.identifier" direction="response" resource="Patient"/>
        <nts:include value="assert.birthdate" direction="response" resource="Patient" date="2004-11-12"/>-->
      <!-- Test Organization resource -->
      <!--        <action>
            <assert>
                <description value="Test if a organization with a URA identifier '32320038' exists"/>
                <direction value="response"/>
                    <expression value= "Bundle.entry.where(resource.is(Organization)).resource.identifier.where(system = 'http://fhir.nl/fhir/NamingSystem/ura').where(value = '32320038').exists()" />
            </assert>
        </action>
        <action>
            <assert>
                <description value="Test if a organization with name 'GGD Gelderland-Zuid' exists"/>
                <direction value="response"/>
                    <expression value= "Bundle.entry.where(resource.is(Organization)).resource.identifier.where(system = 'http://fhir.nl/fhir/NamingSystem/ura').where(value = '32320038').exists()" />
            </assert>
        </action>-->
      <!-- Test Organization resource (HealthcareProvider Organisation)-->
      <!-- Test Location resource (HealthcareProvider) -->
      <!-- Test Practitioner resource (HealthProfessional Practitioner) -->
      <!--            <nts:include value="assert.identifier.healthcareprovider" direction="request" resource="Practitioner" system="http://fhir.nl/fhir/NamingSystem/big" code="75131313"/>-->
      <!-- Test PractitionerRole resource (HealthProfessional PractitionerRole) -->
   </test>
</TestScript>
