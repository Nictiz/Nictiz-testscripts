<?xml version="1.0" encoding="UTF-8"?>
<?xml-model href="http://hl7.org/fhir/STU3/testscript.sch" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?>
<TestScript xmlns="http://hl7.org/fhir"
            xmlns:nts="http://nictiz.nl/xsl/testscript"
            nts:scenario="server">
   <id value="xis-1-2-serve-bodyheight"/>
   <version value="stu3-2.0"/>
   <name value="SelfMeasurements - XIS Server - Test Scenario 2.X - Serve bodyheight Observation resources"/>
   <description value="Scenario 2.X - Serve all bodyheight Observation resources"/>
   <nts:authToken patientResourceId="selfmeasurements-Patient-XXX-Smorenburg"/>
   <nts:includeDateT value="yes"/>
   <test id="scenario2-1-serve-all-bodyheight">
        
        <!--<nts:contentAsserts href="resources-serve-retrieve/selfmeasurements-BodyHeight2.xml" expression=".where(code.coding.where(code='8302-2' and system='http://loinc.org')).value.ofType(Quantity).where(value=187 and code='cm').exists()"/>
        <nts:contentAsserts href="resources-serve-retrieve/selfmeasurements-BodyHeight3.xml" expression=".where(code.coding.where(code='8302-2' and system='http://loinc.org')).value.ofType(Quantity).where(value=187 and code='cm').exists()"/>
        <nts:contentAsserts href="resources-serve-retrieve/selfmeasurements-BodyHeight4.xml" expression=".where(code.coding.where(code='8302-2' and system='http://loinc.org')).value.ofType(Quantity).where(value=187 and code='cm').exists()"/>
        <nts:contentAsserts href="resources-serve-retrieve/selfmeasurements-BodyHeight5.xml" expression=".where(code.coding.where(code='8302-2' and system='http://loinc.org')).value.ofType(Quantity).where(value=187 and code='cm').exists()"/>
        <nts:contentAsserts href="resources-serve-retrieve/selfmeasurements-BodyHeight6.xml" expression=".where(code.coding.where(code='8302-2' and system='http://loinc.org')).value.ofType(Quantity).where(value=187 and code='cm').exists()"/>
        <nts:contentAsserts href="resources-serve-retrieve/selfmeasurements-BodyHeight7.xml" expression=".where(code.coding.where(code='8302-2' and system='http://loinc.org')).value.ofType(Quantity).where(value=187 and code='cm').exists()"/>-->
        
        <name value="Scenario 2.1"/>
        <description value="Serve all bodyheight Observation resources"/>
        <nts:include value="medmij/test.xis.successfulSearch"
                   scope="common"
                   resource="Observation"
                   params="?code=http://loinc.org|8302-2"/>
        <nts:include value="assert.response.numResources"
                   scope="common"
                   resource="Observation"
                   count="7"/>
    </test>
   <test>
      <name value="check-selfmeasurements-BodyHeight1"/>
      <action>
         <assert nts:stopTestOnFail="true">
            <description value="Response Bundle contains 1 Observation resource that contains code '8302-2|http://loinc.org' and contains valueQuantity '187|cm'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(code.coding.where(code='8302-2' and system='http://loinc.org')).where(value.ofType(Quantity).where(value=187 and code='cm')).count() = 1.count() = 1"/>
         </assert>
      </action>
      <action>
         <assert nts:stopTestOnFail="true">
            <description value="Observation resource evaluated in the previous assert contains an .id"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(code.coding.where(code='8302-2' and system='http://loinc.org')).where(value.ofType(Quantity).where(value=187 and code='cm')).count() = 1.id.exists()"/>
         </assert>
      </action>
      <variable>
         <name value="selfmeasurements-BodyHeight1-id"/>
         <description value="Resource.id for Observation X"/>
         <expression value="Bundle.entry.resource.ofType(Observation).where(code.coding.where(code='8302-2' and system='http://loinc.org')).where(value.ofType(Quantity).where(value=187 and code='cm')).count() = 1.id"/>
      </variable>
      <action>
         <assert>
            <description value="Observation X contains .identifier with .system and .value"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(id = '${selfmeasurements-BodyHeight1-id}').identifier.where(system.exists() and value.exists())"/>
         </assert>
      </action>
      <action>
         <assert>
            <description value="Observation X contains .status with value 'final'"/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(id = '${selfmeasurements-BodyHeight1-id}').status = 'final'"/>
         </assert>
      </action>
      <action>
         <assert>
            <description value="Observation X contains .category with ..."/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(id = '${selfmeasurements-BodyHeight1-id}').category.where(coding.where(system = 'http://hl7.org/fhir/observation-category' and code = 'vital-signs' and display.exists())).exists()"/>
         </assert>
      </action>
      <action>
         <assert>
            <description value="Observation X contains .code with ..."/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(id = '${selfmeasurements-BodyHeight1-id}').code.where(coding.where(system = 'http://loinc.org' and code = '8302-2' and display.exists()) and coding.where(system = 'http://snomed.info/sct' and code = '10904000' and display.exists())).exists()"/>
         </assert>
      </action>
      <action>
         <assert>
            <description value="Observation X contains .subject with ..."/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(id = '${selfmeasurements-BodyHeight1-id}').subject.where((reference.where( startsWith('http://') or startsWith('https://') or startsWith('#') or matches('^urn:oid:[0-2](\\.(0|[1-9]\\d*))*$') or matches('^urn:uuid:[A-Fa-f\\d]{8}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{12}$') or (startsWith('urn:').not() and startsWith('#').not() and matches('^[A-Za-z]{3,}/[^/]+$')) ).exists() or identifier.exists()) and display.exists()).exists()"/>
         </assert>
      </action>
      <action>
         <assert>
            <description value="Observation X contains .effectiveDateTime with ..."/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(id = '${selfmeasurements-BodyHeight1-id}').effective ~ @${T} - 14 days"/>
         </assert>
      </action>
      <action>
         <assert>
            <description value="Observation X contains .performer with ..."/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(id = '${selfmeasurements-BodyHeight1-id}').performer.where((reference.where( startsWith('http://') or startsWith('https://') or startsWith('#') or matches('^urn:oid:[0-2](\\.(0|[1-9]\\d*))*$') or matches('^urn:uuid:[A-Fa-f\\d]{8}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{4}-[A-Fa-f\\d]{12}$') or (startsWith('urn:').not() and startsWith('#').not() and matches('^[A-Za-z]{3,}/[^/]+$')) ).exists() or identifier.exists()) and display.exists()).exists()"/>
         </assert>
      </action>
      <action>
         <assert>
            <description value="Observation X contains .valueQuantity with ..."/>
            <direction value="response"/>
            <expression value="Bundle.entry.resource.ofType(Observation).where(id = '${selfmeasurements-BodyHeight1-id}').value.where(value = 187 and unit.exists() and system = 'http://unitsofmeasure.org' and code = 'cm').exists()"/>
         </assert>
      </action>
   </test>
</TestScript>
