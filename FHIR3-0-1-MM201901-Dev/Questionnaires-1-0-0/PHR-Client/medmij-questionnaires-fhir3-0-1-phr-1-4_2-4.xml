<?xml-model href="http://hl7.org/fhir/STU3/testscript.sch" type="application/xml" schematypens="http://purl.oclc.org/dsdl/schematron"?>
<TestScript xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://hl7.org/fhir http://hl7.org/fhir/STU3/fhir-all.xsd" xmlns="http://hl7.org/fhir">
    <id value="medmij-questionnaires-fhir3-0-1-phr-1.4-2.4"/>
    <url value="http://nictiz.nl/fhir/fhir3-0-1/TestScript/medmij-questionnaires-fhir3-0-1-phr-1.4-2.4"/>
    <name value="MedMij Questionnaires - PHR Client - Scenario 1.4 and 2.4"/>
    <status value="active"/>
    <date value="2020-04-03"/>
    <publisher value="Nictiz"/>
    <contact>
        <name value="Nictiz"/>
        <telecom>
            <system value="email"/>
            <value value="kwalificatie@nictiz.nl"/>
            <use value="work"/>
        </telecom>
    </contact>
    <description value="MedMij Questionnaires for FHIR STU3 - PHR Client - Scenario 1.4 and 2.4 - Retrieve QuestionnaireProvisioningTask with invalid reference, and reject QuestionnaireProvisioningTask"/>
    <origin>
        <index value="1"/>
        <profile>
            <system value="http://hl7.org/fhir/testscript-profile-origin-types"/>
            <code value="FHIR-Client"/>
        </profile>
    </origin>
    <destination>
        <index value="1"/>
        <profile>
            <system value="http://hl7.org/fhir/testscript-profile-destination-types"/>
            <code value="FHIR-Server"/>
        </profile>
    </destination>
    <fixture id="patient3-token-fixture">
        <resource>
            <reference value="../_reference/medmij-questionnaires-fhir3-0-1-nl-core-patient-BIE-token.xml"/>
        </resource>
    </fixture>
    <fixture id="task-requested-fixture">
        <resource>
            <reference value="../_reference/resources/resources-specific/medmij-questionnaires-fhir3-0-1-vl-QuestionnaireProvisioningTask-Bie-invalid-REQUESTED.xml"/>
        </resource>
    </fixture>
    <fixture id="task-failed-fixture">
        <resource>
            <reference value="../_reference/resources/resources-specific/medmij-questionnaires-fhir3-0-1-vl-QuestionnaireProvisioningTask-Bie-invalid-FAILED.xml"/>
        </resource>
    </fixture>
    <variable>
        <name value="patient3-token-id"/>
        <expression value="Patient.id"/>
        <sourceId value="patient3-token-fixture"/>
    </variable>
    <variable>
        <name value="task-id"/>
        <expression value="Task.id"/>
        <sourceId value="task-requested-fixture"/>
    </variable>
    <variable>
        <name value="T"/>
        <defaultValue value="${CURRENTDATE}"/>
        <description value="Date that data and queries are expected to be relative to."/>
    </variable>
    
    <setup>
        <!-- Search for open Tasks. If they are present, another test is 
             running at the moment and this test cannot proceed. -->
        <action>
            <operation>
                <type>
                    <system value="http://hl7.org/fhir/testscript-operation-codes"/>
                    <code value="search"/>
                </type>
                <resource value="Task"/>
                <description value="Test PHR client to search for QuestionnaireReferenceTask resources with status 'requested'."/>
                <destination value="1"/>
                <origin value="1"/>
                <params value="?code=http://loinc.org|74468-0&amp;status=requested"/>
                <requestHeader>
                    <!-- 0..* Each operation can have one or more header elements -->
                    <field value="Authorization"/>
                    <!-- 1..1 HTTP header field name: OAuth access token -->
                    <value value="${patient3-token-id}"/>
                    <!-- 1..1 HTTP headerfield value: UUID4 -->
                </requestHeader>
                <responseId value="search-response"/>
            </operation>
        </action>
        <action>
            <assert>
                <description value="If this test fails, someone else is running a test for this patient at the moment. Please try again at some later time or contact Nictiz Qualifications if this issue persists."/>
                <expression value="Bundle.total = 0"/>
            </assert>
        </action>
        
        <!-- Create Task resource with unique ID.
             Note: the "autocreate" option can't be used because it misses the authorization headers -->
        <action>
            <operation>
                <type>
                    <system value="http://hl7.org/fhir/testscript-operation-codes"/>
                    <code value="updateCreate"/>
                </type>
                <resource value="Task"/>
                <description value="Create QuestionnaireReferenceTask for the PHR client to act on."/>
                <destination value="1"/>
                <params value="/${task-id}"/>
                <requestHeader>
                    <!-- 0..* Each operation can have one or more header elements -->
                    <field value="Authorization"/>
                    <!-- 1..1 HTTP header field name: OAuth access token -->
                    <value value="${patient3-token-id}"/>
                    <!-- 1..1 HTTP headerfield value: UUID4 -->
                </requestHeader>
                <sourceId value="task-requested-fixture"/>
            </operation>
        </action>
    </setup>
    
    <test id="Scenario1.4-SearchTask">
        <name value="Scenario1.4 - Search QuestionnaireProvisioningTask(s) for patient 3"/>
        <description value="Test PHR client to search for QuestionnaireProvisioningTasks with status 'requested'."/>
        <action>
            <operation>
                <type>
                    <system value="http://hl7.org/fhir/testscript-operation-codes"/>
                    <code value="search"/>
                </type>
                <resource value="Task"/>
                <description value="Test PHR client to search for QuestionnaireReferenceTask resources with status 'requested'."/>
                <destination value="1"/>
                <origin value="1"/>
                <params value="?code=http://loinc.org|74468-0&amp;status=requested"/>
                <requestHeader>
                    <!-- 0..* Each operation can have one or more header elements -->
                    <field value="Authorization"/>
                    <!-- 1..1 HTTP header field name: OAuth access token -->
                    <value value="${patient3-token-id}"/>
                    <!-- 1..1 HTTP headerfield value: UUID4 -->
                </requestHeader>
                <responseId value="search-response"/>
            </operation>
        </action>
        <action>
            <assert>
                <description value="Confirm that HTTP header Authorization contains the patient token {$patient3-token-id}"/>
                <direction value="request"/>
                <headerField value="Authorization"/>
                <value value="${patient3-token-id}"/>
            </assert>
        </action>
        <action>
            <assert>
                <description value="Confirm that query parameter 'owner=' was not present to avoid BSNs in the URL."/>
                <direction value="request"/>
                <operator value="notContains"/>
                <requestURL value="owner="/>
            </assert>
        </action>
        <action>
            <assert>
                <description value="Confirm that query parameter 'subject=' was not present to avoid BSNs in the URL."/>
                <direction value="request"/>
                <operator value="notContains"/>
                <requestURL value="subject="/>
            </assert>
        </action>
        <action>
            <assert>
                <description value="Confirm that the search returns a Bundle with one entry."/>
                <direction value="response"/>
                <expression value="Bundle.total = 1"/>
            </assert>
        </action>
    </test>
    
    <test id="Scenario2.4-FailTask">
        <name value="Scenario2.4 - Set QuestionnaireProvisioningTask to 'failed'"/>
        <description value="Test PHR client to set the status of the QuestionnaireProvisioningTask to 'failed' when the Questionnaire cannot be retrieved."/>
        <action>
            <operation>
                <type>
                    <system value="http://hl7.org/fhir/testscript-operation-codes"/>
                    <code value="update"/>
                </type>
                <resource value="Task"/>
                <description value="Test PHR client to update the QuestionnaireProvisioningTask with status 'failed'."/>
                <destination value="1"/>
                <origin value="1"/>
                <params value="/${task-id}"/>
                <requestHeader>
                    <!-- 0..* Each operation can have one or more header elements -->
                    <field value="Authorization"/>
                    <!-- 1..1 HTTP header field name: OAuth access token -->
                    <value value="${patient3-token-id}"/>
                    <!-- 1..1 HTTP headerfield value: UUID4 -->
                </requestHeader>
                <sourceId value="task-failed-fixture"/>
            </operation>
        </action>
        <action>
            <assert>
                <description value="Confirm that HTTP header Authorization contains the patient token {$patient3-token-id}"/>
                <direction value="request"/>
                <headerField value="Authorization"/>
                <value value="${patient3-token-id}"/>
            </assert>
        </action>
        <!-- TODO: Enable when package is loaded -->
        <!--        <action>
            <assert>
                <description value="Confirm that the Task conforms to the required profile"/>
                <direction value="request"/>
                <validateProfileId value="Task-profile"/>
            </assert>
        </action>
-->     
        <action>
            <assert>
                <description value="Confirm that the Task instance declares its profile"/>
                <direction value="request"/>
                <expression value="meta.profile = 'http://nictiz.nl/fhir/StructureDefinition/vl-QuestionnaireProvisioningTask'"/>
            </assert>
        </action>
        <action>
            <assert>
                <description value="Confirm that the status of the Task is 'failed'"/>
                <direction value="request"/>
                <expression value="Task.status = 'failed'"/>
            </assert>
        </action>
        <!-- TODO: This doesn't seem to work -->
        <!--        <action>
            <assert>
                <description value="Confirm that the Task contains all the same information as the original task"/>
                <direction value="request"/>
                <minimumId value="task-requested-fixture"/>
            </assert>
        </action>
-->        <action>
            <assert>
                <description value="Confirm that the operation was succesful"/>
                <operator value="in"/>
                <responseCode value="200,201"/>
            </assert>
        </action>
    </test>
    
    <teardown>
        <action>
            <operation>
                <!-- Delete the (now modified) Task resource.
                     Note: the "autodelete" option can't be used because it misses the authorization headers -->
                <type>
                    <system value="http://hl7.org/fhir/testscript-operation-codes"/>
                    <code value="delete"/>
                </type>
                <resource value="Task"/>
                <description value="Delete the Task resource that was created for this test"/>
                <destination value="1"/>
                <params value="/${task-id}"/>
                <requestHeader>
                    <!-- 0..* Each operation can have one or more header elements -->
                    <field value="Authorization"/>
                    <!-- 1..1 HTTP header field name: OAuth access token -->
                    <value value="${patient3-token-id}"/>
                    <!-- 1..1 HTTP headerfield value: UUID4 -->
                </requestHeader>
            </operation>
        </action>    </teardown>
</TestScript>
