{
  "resourceType": "TestScript",
  "id": "C-Serve-Scenario1-1-QuestionnaireResponse-xml",
  "contact": [
    {
      "telecom": [
        {
          "system": "email",
          "value": "info@iknl.nl"
        }
      ],
      "name": "IKNL"
    }
  ],
  "origin": [
    {
      "extension": [
        {
          "url": "http://fhir.interoplab.eu/fhir/StructureDefinition/Interoplab-CL-ext-SUT",
          "valueBoolean": false
        }
      ],
      "profile": {
        "system": "http://terminology.hl7.org/CodeSystem/testscript-profile-origin-types",
        "code": "FHIR-Client"
      },
      "index": 1
    }
  ],
  "destination": [
    {
      "extension": [
        {
          "url": "http://fhir.interoplab.eu/fhir/StructureDefinition/Interoplab-CL-ext-SUT",
          "valueBoolean": true
        }
      ],
      "profile": {
        "system": "http://terminology.hl7.org/CodeSystem/testscript-profile-destination-types",
        "code": "FHIR-Server"
      },
      "index": 1
    }
  ],
  "variable": [
    {
      "name": "patient-token-id",
      "defaultValue": "Basic TmljdGl6OlBhc3N3b3Jk",
      "description": "OAuth Token for current patient"
    }
  ],
  "test": [
    {
      "action": [
        {
          "operation": {
            "requestHeader": [
              {
                "field": "Authorization",
                "value": "#{patient-token-id}"
              }
            ],
            "type": {
              "code": "search",
              "system": "http://hl7.org/fhir/restful-interaction"
            },
            "resource": "QuestionnaireResponse",
            "description": "Test server to serve ACP related QuestionnaireResponse resources.",
            "encodeRequestUrl": true,
            "origin": 1,
            "destination": 1,
            "params": "?patient=Patient/D1-ACP-Patient&questionnaire=https://api.iknl.nl/docs/pzp/r4/Questionnaire/ACP-zib2020",
            "accept": "xml"
          }
        },
        {
          "assert": {
            "description": "Make sure that the server of the test simulator gives a success response.",
            "direction": "response",
            "responseCode": "okay",
            "warningOnly": false
          }
        },
        {
          "assert": {
            "description": "Confirm that the returned Bundle type is searchset.",
            "direction": "response",
            "expression": "Bundle.type",
            "operator": "equals",
            "value": "searchset",
            "warningOnly": false
          }
        },
        {
          "assert": {
            "description": "Confirm that all returned resources contain an Resource.id except when temporary ids are used in the Bundle. The only time that a resource does not have an id is when it is being submitted to the server using a create operation: https://www.hl7.org/fhir/STU3/resource-definitions.html#Resource.id",
            "direction": "response",
            "expression": "Bundle.entry.all( $this.fullUrl.matches('^urn:oid:[0-2](\\\\.(0|[1-9]\\\\d*))*$') or $this.fullUrl.matches('^urn:uuid:[A-Fa-f\\\\d]{8}-[A-Fa-f\\\\d]{4}-[A-Fa-f\\\\d]{4}-[A-Fa-f\\\\d]{4}-[A-Fa-f\\\\d]{12}$') or $this.resource.id.exists())",
            "warningOnly": false
          }
        },
        {
          "assert": {
            "description": "Confirm that all returned resources except OperationOutcome and Binary contain a meta.profile tag.",
            "direction": "response",
            "expression": "Bundle.entry.resource.where(is(OperationOutcome).not()).where(is(Binary).not()).where(meta.profile.empty()).empty()",
            "warningOnly": false
          }
        },
        {
          "assert": {
            "description": "Confirm that the fullUrl does not disagree with the id in the resource, see http://hl7.org/fhir/stu3/bundle-definitions.html#Bundle.entry.fullUrl",
            "direction": "response",
            "expression": "Bundle.entry.where(fullUrl.exists() and resource.id.exists()).all($this.fullUrl.endsWith($this.resource.id))",
            "warningOnly": false
          }
        },
        {
          "assert": {
            "description": "Confirm that the fullUrl is an absolute URL, an uuid or an oid.",
            "direction": "response",
            "expression": "Bundle.entry.fullUrl.all( startsWith('http://') or startsWith('https://') or matches('^urn:oid:[0-2](\\\\.(0|[1-9]\\\\d*))*$') or matches('^urn:uuid:[A-Fa-f\\\\d]{8}-[A-Fa-f\\\\d]{4}-[A-Fa-f\\\\d]{4}-[A-Fa-f\\\\d]{4}-[A-Fa-f\\\\d]{12}$') )",
            "warningOnly": false
          }
        },
        {
          "assert": {
            "description": "Confirm that the returned Bundle conforms to the base FHIR specification and the resources to the stated profiles in the meta.profile tag.",
            "direction": "response",
            "validateProfileId": "Bundle-profile",
            "warningOnly": false
          }
        },
        {
          "assert": {
            "description": "Confirm that all Coding elements contain both a .system and a .code.",
            "direction": "response",
            "expression": "Bundle.descendants().where($this.is(Coding)).all(system.exists() and code.exists())",
            "warningOnly": false
          }
        },
        {
          "assert": {
            "description": "Confirm that the OID of the zib valueset is not used for the system of a coding element.",
            "direction": "response",
            "expression": "Bundle.descendants().where($this.is(coding)).where(system.startsWith('urn:oid:2.16.840.1.113883.2.4.3.11.60.40.2')).exists().not()",
            "warningOnly": false
          }
        },
        {
          "assert": {
            "description": "Confirm that all CodeableConcept elements contain either a coding.display or a text value if no Coding exists or has an extension (e.g. a nullFlavor or data-absent-reason extension). For more information see https://informatiestandaarden.nictiz.nl/wiki/FHIR:V1.0_FHIR_IG_STU3Use_of_coded_concepts.",
            "direction": "response",
            "expression": "Bundle.descendants().where($this.is(CodeableConcept)) .all(coding.display.exists() or text.exists() or extension.exists())",
            "warningOnly": false
          }
        },
        {
          "assert": {
            "description": "Confirm that all References have a display value, see https://informatiestandaarden.nictiz.nl/wiki/FHIR:V1.0_FHIR_IG_STU3#Use_of_the_reference_datatype.",
            "direction": "response",
            "expression": "Bundle.descendants().where($this.is(Reference)).all(display.exists() or extension.where(url = 'http://hl7.org/fhir/StructureDefinition/data-absent-reason').exists() or extension.where(url = 'http://hl7.org/fhir/StructureDefinition/iso21090-nullFlavor').exists())",
            "warningOnly": false
          }
        },
        {
          "assert": {
            "description": "Confirm that all Identifiers have both a .system and a .value. In rare cases where a general category of identifiers can be used, .type can replace .system. Edge cases for both .system and .type to be unknown are not applicable to Nictiz. For more information, see https://www.hl7.org/fhir/stu3/datatypes.html#Identifier.",
            "direction": "response",
            "expression": "Bundle.descendants().where($this.is(Identifier)).all((system.exists() or type.exists()) and value.exists())",
            "warningOnly": false
          }
        },
        {
          "assert": {
            "description": "Confirm that the returned Bundle total value matches or is less than the number of entries in the Bundle. The included resources should not be counted as entries in the Bundle.total.",
            "direction": "response",
            "expression": "Bundle.total.exists() implies (Bundle.total.toInteger() <= Bundle.entry.where(search.empty() or search.mode = 'match').count())",
            "warningOnly": false
          }
        },
        {
          "assert": {
            "description": "Confirm that the returned Bundle contains a self link.",
            "direction": "response",
            "expression": "Bundle.link.where(relation = 'self' and url.exists()).exists()",
            "warningOnly": false
          }
        },
        {
          "assert": {
            "extension": [
              {
                "extension": [
                  {
                    "url": "ruleId",
                    "valueId": "assert-response-queryParamsInSelfLink"
                  }
                ],
                "url": "http://touchstone.aegis.net/touchstone/fhir/testing/StructureDefinition/testscript-assert-rule"
              }
            ],
            "description": "Confirm that the parameters in the request URL are all handled by the server, by inspecting the self link.",
            "warningOnly": true
          }
        },
        {
          "assert": {
            "description": "Confirm that the response Bundle contains 1 QuestionnaireResponse resource(s).",
            "direction": "response",
            "expression": "Bundle.entry.where(resource.is(QuestionnaireResponse)).count() = 1",
            "warningOnly": false
          }
        }
      ],
      "id": "ServeACPQuestionnaireResponse",
      "name": "ServeACPQuestionnaireResponse",
      "description": "Serve QuestionnaireResponse resources representing ACP form."
    }
  ],
  "status": "active",
  "version": "1.0.0-rc1",
  "date": "2025-12-09",
  "publisher": "IKNL",
  "copyright": "Copyright and related rights waived via CC0, https://creativecommons.org/publicdomain/zero/1.0/. This does not apply to information from third parties, for example a medical terminology system. The implementer alone is responsible for identifying and obtaining any necessary licenses or authorizations to utilize third party IP in connection with the specification or otherwise.",
  "url": "https://api.iknl.nl/docs/pzp/r4/TestScript/C-Serve-Scenario1-1-QuestionnaireResponse-xml",
  "name": "C-Serve-Scenario1-1-QuestionnaireResponse-xml"
}
